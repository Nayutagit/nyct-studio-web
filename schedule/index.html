<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Schedule | ニストスタジオ</title>
    <link rel="icon" href="../img/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=Zen+Kaku+Gothic+New:wght@300;400;500;700;900&family=Zen+Old+Mincho:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../style.css?v=4?v=3">
</head>

<body>

    <!-- Header -->
    <header class="header">
        <div class="container header-inner">
            <a href="../index.html" class="logo">
                <img src="../img/logo_white.png" alt="Nyct Studio Logo">
                ニストスタジオ
            </a>
            <nav>
                <ul class="nav-list">
                    <li><a href="../udatsu.html" class="nav-link" style="color: var(--primary-neon);">Udatsu</a></li>
                    <li><a href="../about.html" class="nav-link">About</a></li>
                    <li><a href="../voice.html" class="nav-link">Voice</a></li>
                    <li><a href="../school.html" class="nav-link">School</a></li>
                    <li><a href="./" class="nav-link active">Schedule</a></li>
                    <li><a href="../incubation.html" class="nav-link">Incubation</a></li>
                    <li><a href="../blog.html" class="nav-link">Blog</a></li>
                    <li><a href="../shop.html" class="nav-link">Shop</a></li>
                    <li><a href="../contact.html" class="nav-link">Contact</a></li>
                </ul>
                <div class="menu-toggle"><i class="fas fa-bars"></i></div>
            </nav>
        </div>
    </header>

    <!-- Page Hero -->
    <section class="page-hero">
        <div class="container page-hero-content">
            <span class="section-subtitle">RESERVATION</span>
            <h1 class="page-title">LESSON SCHEDULE</h1>
            <p class="page-desc">
                レッスンの空き状況をご確認いただけます。<br>
                ご希望の日時を選択してご予約ください。
            </p>
        </div>
    </section>

    <!-- Calendar Section -->
    <section class="section bg-dark-concrete">
        <div class="container">

            <div class="calendar-controls">
                <button class="cal-btn" id="prevWeek"><i class="fas fa-chevron-left"></i> 前の週</button>
                <h2 class="current-month">2025年 12月</h2>
                <button class="cal-btn" id="nextWeek">次の週 <i class="fas fa-chevron-right"></i></button>
            </div>

            <div class="calendar-legend">
                <div class="legend-item"><span class="status-icon status-ok">◎</span> 余裕あり</div>
                <div class="legend-item"><span class="status-icon status-few">△</span> 残りわずか</div>
                <div class="legend-item"><span class="status-icon status-full">×</span> 満席</div>
                <div class="legend-item"><span class="status-icon status-ng">-</span> 受付不可</div>
            </div>

            <div class="schedule-grid">
                <div class="schedule-header">
                    <!-- JS Injected -->
                </div>
                <!-- Hourly Grid Body -->
                <div id="schedule-body">
                    <!-- JS Injected -->
                </div>
            </div>

            <div class="schedule-note">
                ※ 表示されている時間は開始時間です。<br>
                ※ ◯・△をクリックすると予約フォームへ進みます。
            </div>

            <!-- CTA -->
            <div class="cta-grid">
                <div class="cta-card">
                    <h3>初めての方へ</h3>
                    <p>
                        初回体験レッスンは無料です。<br>
                        まずはカウンセリングから、お気軽にご相談ください。
                    </p>
                    <a href="../contact.html" class="btn btn-primary">お問い合わせ・予約</a>
                </div>
                <div class="cta-card">
                    <h3>会員の方へ</h3>
                    <p>
                        いつもご利用ありがとうございます。<br>
                        ご予約の変更・キャンセルは前日までにお願いいたします。
                    </p>
                    <a href="mailto:reserve@nyct.jp" class="btn btn-secondary">メールで連絡する</a>
                </div>
            </div>

        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div>
                    <a href="../index.html" class="footer-logo">ニストスタジオ</a>
                    <p class="section-description">
                        「やりたい」を形にするために。<br>
                        声のプロとして、そして次世代を育てる指導者として。<br>
                        ニストスタジオは、あなたの可能性を広げ続けます。
                    </p>
                </div>
                <div class="footer-links">
                    <div>
                        <h4>Business</h4>
                        <ul>
                            <li><a href="../voice.html">Voice / Narration</a></li>
                            <li><a href="../school.html">School</a></li>
                            <li><a href="../incubation.html">Incubation</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4>Studio</h4>
                        <ul>
                            <li><a href="../about.html">About Us</a></li>
                            <li><a href="../contact.html">Contact</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4>Social</h4>
                        <ul>
                            <li><a href="https://note.com/udatsu_vj" target="_blank">Note</a></li>
                            <li><a href="https://instagram.com/nyctstudio" target="_blank">Instagram</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="copyright">
                &copy; 2025 Nyct Studio. All Rights Reserved.
            </div>
        </div>
    </footer>

    <!-- Reservation Modal -->
    <div class="modal-overlay" id="bookingModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
            <h2 style="text-align: center; margin-bottom: 20px; font-family: var(--font-serif); color:white;">仮予約フォーム
            </h2>

            <div class="booking-info">
                <h4 id="modalDate" style="color: var(--primary-neon);">2025/12/10 (Wed)</h4>
                <div id="modalTime" style="font-size: 1.5rem; font-weight: bold; color:white;">10:00</div>
            </div>

            <form action="https://formspree.io/f/xanzkprd" method="POST">
                <input type="hidden" name="date" id="formDate">
                <input type="hidden" name="time" id="formTime">
                <input type="hidden" name="subject" value="レッスン仮予約申し込み">

                <div class="form-group">
                    <label class="form-label">お名前</label>
                    <input type="text" name="name" class="form-input" required placeholder="山田 太郎">
                </div>

                <div class="form-group">
                    <label class="form-label">メールアドレス</label>
                    <input type="email" name="email" class="form-input" required placeholder="email@example.com">
                </div>

                <div class="form-group">
                    <label class="form-label">メッセージ・ご要望</label>
                    <textarea name="message" class="form-textarea" rows="3" placeholder="過去にレッスン経験あり、など"></textarea>
                </div>

                <p style="font-size: 0.8rem; color: #888; margin-bottom: 20px;">
                    ※ご予約はまだ確定ではありません。<br>
                    ※講師からの返信をもって予約確定となります。
                </p>

                <button type="submit" class="btn btn-primary" style="width: 100%;">仮予約を送信する</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://yptegzzukymqotzchgnp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwdGVnenp1a3ltcW90emNoZ25wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NDU1MTYsImV4cCI6MjA3OTQyMTUxNn0.iKWkVYwlKrSBlJKUxRebbGRcgvprzkcyAOgDaCHKLSY';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentStartDate = new Date();

        // Modal Logic
        function openModal(dateStr, timeStr) {
            const modal = document.getElementById('bookingModal');
            document.getElementById('modalDate').textContent = dateStr;
            document.getElementById('modalTime').textContent = timeStr;
            // For form hidden inputs, use standard YYYY-MM-DD
            // But here dateStr might be '12/10 (Wed)'
            // We need to store exact ISO date in dataset or regenerate it
            // For now let's just use what we have, or better, pass the raw date key
            // The onclick passes dispDate. 
            document.getElementById('formDate').value = dateStr;
            document.getElementById('formTime').value = timeStr;
            modal.classList.add('active');
        }

        window.closeModal = function () {
            document.getElementById('bookingModal').classList.remove('active');
        }

        // Format helpers
        const formatDateKey = (date) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        const formatDisplayDate = (date) => {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            return `${date.getMonth() + 1}/${date.getDate()} (${days[date.getDay()]})`;
        };

        const START_HOUR = 10;
        const END_HOUR = 22;
        const HOURS = [];
        for (let i = START_HOUR; i <= END_HOUR; i++) {
            HOURS.push(`${i}:00`);
        }

        async function fetchSchedule(startDate) {
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(startDate);
                d.setDate(startDate.getDate() + i);
                dates.push(d);
            }

            // Render Headers
            const headerContainer = document.querySelector('.schedule-header');
            headerContainer.innerHTML = '';
            // Empty corner cell
            const corner = document.createElement('div');
            corner.className = 'date-col header-corner';
            corner.textContent = '';
            headerContainer.appendChild(corner);

            dates.forEach(d => {
                const div = document.createElement('div');
                div.className = 'date-col';
                if (d.getDay() === 6) div.classList.add('sat');
                if (d.getDay() === 0) div.classList.add('sun');
                div.innerHTML = `<span>${formatDisplayDate(d)}</span>`;
                headerContainer.appendChild(div);
            });

            // Set date attributes for slots and fetch data
            const dateKeys = dates.map(formatDateKey);

            let dataMap = {};
            try {
                const { data, error } = await client
                    .from('schedule_slots')
                    .select('*')
                    .in('date', dateKeys);

                if (data && !error) {
                    data.forEach(item => {
                        if (!dataMap[item.date]) dataMap[item.date] = {};
                        dataMap[item.date][item.time_code] = item.status;
                    });
                }
            } catch (e) {
                console.error('Supabase fetch error:', e);
            }

            const bodyContainer = document.getElementById('schedule-body');
            bodyContainer.innerHTML = '';

            HOURS.forEach((timeCode) => {
                const row = document.createElement('div');
                row.className = 'schedule-row';

                // Time Label
                const timeLabel = document.createElement('div');
                timeLabel.className = 'time-label';
                timeLabel.textContent = timeCode;
                row.appendChild(timeLabel);

                dates.forEach((d) => {
                    const dateKey = formatDateKey(d);
                    const dispDate = formatDisplayDate(d);

                    let status = 'status-ok';
                    if (dataMap[dateKey] && dataMap[dateKey][timeCode]) {
                        status = dataMap[dateKey][timeCode];
                    }

                    const div = document.createElement('div');
                    div.className = `slot ${status}`;
                    div.dataset.date = dateKey;
                    div.dataset.time = timeCode;

                    let content = '-';
                    if (status === 'status-ok') content = '◎';
                    else if (status === 'status-few') content = '△';
                    else if (status === 'status-full') content = '×';
                    else if (status === 'status-ng') content = '-';

                    if (status !== 'status-ng' && status !== 'status-full') {
                        div.innerHTML = `<span class="slot-link" style="cursor: pointer;">${content}</span>`;
                        div.onclick = () => openModal(dispDate, timeCode);
                    } else {
                        div.textContent = content;
                    }

                    row.appendChild(div);
                });
                bodyContainer.appendChild(row);
            });

            const title = document.querySelector('.current-month');
            title.textContent = `${startDate.getFullYear()}年 ${startDate.getMonth() + 1}月`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchSchedule(currentStartDate);

            document.getElementById('prevWeek').addEventListener('click', () => {
                const newDate = new Date(currentStartDate);
                newDate.setDate(newDate.getDate() - 7);
                currentStartDate = newDate;
                fetchSchedule(currentStartDate);
            });
            document.getElementById('nextWeek').addEventListener('click', () => {
                const newDate = new Date(currentStartDate);
                newDate.setDate(newDate.getDate() + 7);
                currentStartDate = newDate;
                fetchSchedule(currentStartDate);
            });

            // Hamburger Menu
            const menuToggle = document.querySelector('.menu-toggle');
            const navList = document.querySelector('.nav-list');
            if (menuToggle && navList) {
                menuToggle.addEventListener('click', () => {
                    navList.classList.toggle('active');
                });
            }
        });
    </script>
</body>

</html>