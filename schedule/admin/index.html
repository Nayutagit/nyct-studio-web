<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Schedule | „Éã„Çπ„Éà„Çπ„Çø„Ç∏„Ç™</title>
    <link rel="icon" href="../../img/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../../style.css?v=82">
    <script src="https://kit.fontawesome.com/aa13b8dc63.js" crossorigin="anonymous"></script>
    <style>
        /* 1. Reset & Base Scroll Settings */
        html {
            height: auto !important;
            min-height: 100vh !important;
            overflow-y: scroll !important;
            /* Always show scrollbar to prevent layout shift */
        }

        /* 2. Components - Aggressive Layout Reset */
        body,
        .section,
        .container,
        .schedule-grid {
            display: block !important;
            position: relative !important;
            /* Ensure Grid moves with body */
            float: none !important;
            /* Fix Collapse */
            height: auto !important;
            min-height: 0 !important;
            overflow: visible !important;
        }

        /* Disable Sticky */
        .schedule-header,
        .time-label,
        .header-corner,
        header {
            position: static !important;
        }

        body {
            min-height: 100vh !important;
            padding-bottom: 20rem;
        }

        .schedule-grid {
            min-height: 50vh;
            /* HIGH CONTRAST REMOVED */
            margin-bottom: 100px;
            z-index: 9999 !important;
        }

        /* 3. Branding Fix */
        .logo span {
            margin-left: 0 !important;
        }

        /* 4. Utils */
        .modal-overlay {
            display: none !important;
        }

        .modal-overlay.active {
            display: flex !important;
        }

        .admin-controls {
            margin-bottom: 20px;
            text-align: center;
        }

        .save-status {
            margin-left: 20px;
            color: var(--accent-teal);
            opacity: 0;
            transition: opacity 0.5s;
        }

        .save-status.show {
            opacity: 1;
        }
    </style>
</head>

<body>
    <header class="header">
        <!-- Header -->
        <div class="container header-content">
            <a href="../../index.html" class="logo">
                „Éã„Çπ„Éà„Çπ„Çø„Ç∏„Ç™ Admin <small style="font-size: 0.8rem; opacity: 0.7;">(v3.2 LOGIC RESTORED)</small>
            </a>
            <nav class="nav-links">
                <a href="index.html"
                    style="color: var(--accent-gold); text-decoration: none; margin-right: 20px; font-weight: bold;">„Çπ„Ç±„Ç∏„É•„Éº„É´</a>
                <a href="students.html" style="color: #ccc; text-decoration: none;">ÁîüÂæíÁÆ°ÁêÜ</a>
                <a href="../../index.html" style="margin-left: 20px; font-size: 0.9rem; color: #666;">Exit</a>
            </nav>
        </div>
    </header>

    <section class="section">
        <div class="container">
            <h1 class="section-title">„Çπ„Ç±„Ç∏„É•„Éº„É´ÁÆ°ÁêÜ</h1>
            <p style="text-align: center; margin-bottom: 20px;">„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂ§âÊõ¥Ôºà‚óé ‚Üí -Ôºâ</p>

            <!-- Bulk Update UI -->
            <div
                style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 8px; margin-bottom: 30px; text-align: center;">
                <h3 style="margin-bottom: 15px; font-size: 1.2rem; color: var(--accent-gold);">ÁØÑÂõ≤‰∏ÄÊã¨Êõ¥Êñ∞</h3>
                <div
                    style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; align-items: center; color: #ccc;">
                    <div>
                        <label>ÊúüÈñì:</label>
                        <input type="date" id="bulkStartDate"
                            style="padding: 5px; background: #333; color: white; border: 1px solid #555;">
                        <span>~</span>
                        <input type="date" id="bulkEndDate"
                            style="padding: 5px; background: #333; color: white; border: 1px solid #555;">
                    </div>
                    <div>
                        <label>ÊôÇÈñì:</label>
                        <select id="bulkStartTime"
                            style="padding: 5px; background: #333; color: white; border: 1px solid #555;"></select>
                        <span>~</span>
                        <select id="bulkEndTime"
                            style="padding: 5px; background: #333; color: white; border: 1px solid #555;"></select>
                    </div>
                    <div>
                        <label>„Çπ„ÉÜ„Éº„Çø„Çπ:</label>
                        <select id="bulkStatus"
                            style="padding: 10px; border-radius: 4px; border: 1px solid #444; background: #333; color: white;">
                            <option value="status-ok">‚óé ‰ΩôË£ï„ÅÇ„Çä</option>
                            <option value="status-online">Online Only</option>
                            <option value="status-ng">- Âèó‰ªò‰∏çÂèØ</option>
                        </select>
                    </div>
                </div>
                <button onclick="runBulkUpdate()" class="cal-btn"
                    style="margin-top: 15px; background: var(--accent-blue); width: 150px;">‰∏ÄÊã¨ÈÅ©Áî®</button>
            </div>

            <div class="calendar-controls">
                <button class="cal-btn" id="prevWeek">Ââç„ÅÆÈÄ±</button>
                <h2 class="current-month"></h2>
                <button class="cal-btn" id="nextWeek">Ê¨°„ÅÆÈÄ±</button>
                <span id="saveStatus" class="save-status">‰øùÂ≠ò„Åó„Åæ„Åó„Åü</span>
            </div>

            <!-- Booking Modal -->
            <div id="bookingModal" class="modal-overlay">
                <div class="modal-content">
                    <button class="modal-close" onclick="closeBookingModal()">√ó</button>
                    <h3 style="color: var(--accent-gold); margin-bottom: 20px;">‰∫àÁ¥ÑÊû†Ë®≠ÂÆö</h3>

                    <div class="booking-info">
                        <h4 id="modalTitle" style="color:white; margin:0;"></h4>
                    </div>

                    <div class="form-group">
                        <label class="form-label">„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                        <select id="modalStatus" class="form-input">
                            <option value="status-ok">‚óé ‰∫àÁ¥ÑÂèØËÉΩ</option>
                            <option value="status-online">Online Only</option>
                            <option value="status-ng">- Âèó‰ªò‰∏çÂèØ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ÁîüÂæíÂâ≤„ÇäÂΩì„Å¶</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="studentSearch" class="form-input" placeholder="ÂêçÂâç„ÅßÊ§úÁ¥¢..."
                                oninput="searchStudents()">
                            <input type="hidden" id="selectedStudentId">
                        </div>
                        <div id="studentSearchResults"
                            style="max-height: 150px; overflow-y: auto; margin-top: 5px; background: #333; border: 1px solid #555; display: none;">
                        </div>
                        <div id="selectedStudentName"
                            style="margin-top: 10px; color: var(--primary-neon); font-weight: bold;"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Booking Type</label>
                        <select id="modalBookingType" class="form-input">
                            <option value="Lesson">Lesson</option>
                            <option value="Counseling">Counseling</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">„É°„É¢</label>
                        <textarea id="modalMemo" class="form-textarea" rows="3"></textarea>
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                        <button class="btn btn-secondary" onclick="clearBooking()">Ââ≤„ÇäÂΩì„Å¶Ëß£Èô§ & „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥</button>
                        <button class="btn btn-primary" onclick="saveBooking()">‰øùÂ≠ò</button>
                    </div>
                </div>
            </div>

            <!-- Grid with Inline Fixes but Dark Theme -->
            <div class="schedule-grid" id="schedule-grid"
                style="min-height: 50vh !important; display: block !important; position: relative !important; background: rgba(30,30,30,0.5); border: 1px solid rgba(255,255,255,0.1); margin-bottom: 100px;">
                <div class="schedule-header">
                    <!-- JS Injected -->
                </div>
                <div id="schedule-body">
                    <div class="loader"
                        style="margin: 50px auto; border: 4px solid #333; border-top: 4px solid var(--primary-neon); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;">
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // --- GLOBAL CONFIG ---
        const SUPABASE_URL = 'https://yptegzzukymqotzchgnp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwdGVnenp1a3ltcW90emNoZ25wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NDU1MTYsImV4cCI6MjA3OTQyMTUxNn0.iKWkVYwlKrSBlJKUxRebbGRcgvprzkcyAOgDaCHKLSY';

        const ERR_MSG = "ÂàùÊúüÂåñ„Ç®„É©„Éº: Supabase„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ";

        // --- CONSTANTS ---
        const HOURS = [];
        for (let i = 8; i <= 22; i++) HOURS.push(i + ":00");

        const STATUS_LABELS = {
            'status-ok': '‚óé ‰∫àÁ¥ÑÂèØ',
            'status-ng': '- Âèó‰ªò‰∏çÂèØ',
            'status-online': 'Online Only'
        };

        // --- STATE ---
        let client;
        let scheduleData = {};
        let currentMonthStart = new Date();
        let bookingModalTarget = null; // { date: 'YYYY-MM-DD', time: 'HH:MM' }

        // --- INIT ---
        window.onload = function () {
            try {
                if (typeof supabase === 'undefined') throw new Error(ERR_MSG);
                client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log("Supabase initialized (v3.2)");
                init();
            } catch (err) {
                alert(err.message);
                console.error(err);
            }
        };

        async function init() {
            renderSkeleton();
            await fetchSchedule();
        }

        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        // --- DATA FETCHING (WITH JOIN) ---
        async function fetchSchedule() {
            try {
                const start = getStartOfWeek(currentMonthStart);
                const end = new Date(start);
                end.setDate(end.getDate() + 6);

                const startStr = start.toISOString().split('T')[0];
                const endStr = end.toISOString().split('T')[0];

                // JOIN 'students' table to get names
                const { data: slots, error } = await client
                    .from('schedule_slots')
                    .select('*, students(name, first_name, last_name, alias)')
                    .gte('date', startStr)
                    .lte('date', endStr);

                if (error) throw error;

                scheduleData = {};
                if (slots) {
                    slots.forEach(slot => {
                        const key = `${slot.date}_${slot.time.slice(0, 5)}`; // Handle time format HH:MM:SS
                        scheduleData[key] = slot;
                    });
                }
                renderSchedule(start);
                updateHeaderDate(start);
            } catch (err) {
                console.error("Fetch Error:", err);
                alert("„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
            }
        }

        // --- RENDERING ---
        function renderSkeleton() {
            const grid = document.getElementById('schedule-grid');
            if (!grid) return;
            grid.innerHTML = '';

            // 1. Header Row
            const headerRow = document.createElement('div');
            headerRow.className = 'schedule-header';

            const corner = document.createElement('div');
            corner.className = 'header-corner';
            corner.textContent = 'Time';
            headerRow.appendChild(corner);

            const start = getStartOfWeek(currentMonthStart);
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(start);
                d.setDate(d.getDate() + i);
                dates.push(d);

                const col = document.createElement('div');
                col.className = 'header-date';
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                col.innerHTML = `${dayNames[d.getDay()]}<br><span style="font-size:1.2rem">${d.getDate()}</span>`;
                if (d.toDateString() === new Date().toDateString()) col.classList.add('today');
                headerRow.appendChild(col);
            }
            grid.appendChild(headerRow);

            // 2. Schedule Body
            const body = document.createElement('div');
            body.id = 'schedule-body';
            body.className = 'schedule-body';

            HOURS.forEach(time => {
                const row = document.createElement('div');
                row.className = 'schedule-row';

                // Time Label Left
                const label = document.createElement('div');
                label.className = 'time-label';
                label.textContent = time;
                row.appendChild(label);

                // Slots
                dates.forEach(date => {
                    const dateKey = formatDateKey(date);
                    const slot = document.createElement('div');
                    slot.className = 'slot'; // Base class
                    slot.dataset.date = dateKey;
                    slot.dataset.time = time;
                    slot.onclick = () => openBookingModal(dateKey, time);
                    slot.innerHTML = '<span style="color:#666">...</span>'; // Placeholder
                    row.appendChild(slot);
                });
                body.appendChild(row);
            });
            grid.appendChild(body);
        }

        function renderSchedule(start) {
            const slots = document.querySelectorAll('.slot');
            slots.forEach(slot => {
                const key = `${slot.dataset.date}_${slot.dataset.time}`;
                const data = scheduleData[key];

                slot.className = 'slot'; // Reset
                slot.innerHTML = '';

                if (data) {
                    // Update Class
                    if (data.status === 'status-ng') {
                        slot.classList.add('status-ng');
                        slot.textContent = '-';
                    } else if (data.status === 'status-online') {
                        slot.classList.add('status-online');
                        slot.textContent = 'Online';
                    } else {
                        slot.classList.add('status-ok');
                        slot.textContent = '‚óé';
                    }

                    // Student Info?
                    let displayName = null;
                    if (data.students) {
                        // Prefer LastFirst, then Name, then Alias
                        const s = data.students;
                        if (s.last_name && s.first_name) displayName = `${s.last_name} ${s.first_name}`;
                        else if (s.name) displayName = s.name;
                        else if (s.alias) displayName = s.alias;
                    }

                    if (displayName || data.memo) {
                        const info = document.createElement('div');
                        info.className = 'slot-info';
                        info.style.fontSize = '0.75rem';
                        info.style.marginTop = '2px';
                        info.style.overflow = 'hidden';

                        if (displayName) {
                            const nameSpan = document.createElement('span');
                            nameSpan.style.color = 'var(--primary-neon)';
                            nameSpan.textContent = displayName;
                            info.appendChild(nameSpan);
                        }
                        if (data.memo) {
                            const memoIcon = document.createElement('span');
                            memoIcon.textContent = ' üìù';
                            memoIcon.title = data.memo;
                            info.appendChild(memoIcon);
                        }
                        slot.appendChild(info);
                        slot.classList.add('has-booking'); // Visual Hook
                    }
                } else {
                    // Empty = Default is OK? Or Empty?
                    // Assuming default is OK (‚óé) based on logic
                    slot.classList.add('status-ok');
                    slot.textContent = '‚óé';
                }
            });
        }

        // --- MODAL LOGIC (RESTORED) ---
        function openBookingModal(date, time) {
            bookingModalTarget = { date, time };

            // UI
            document.getElementById('modalTitle').textContent = `${date} ${time}`;
            document.getElementById('bookingModal').classList.add('active');

            // Find Data
            const key = `${date}_${time}`;
            const data = scheduleData[key];

            // Reset Form
            document.getElementById('studentSearch').value = '';
            document.getElementById('studentSearchResults').innerHTML = '';
            document.getElementById('studentSearchResults').style.display = 'none';
            document.getElementById('selectedStudentId').value = '';
            document.getElementById('selectedStudentName').textContent = '';

            if (data) {
                document.getElementById('modalStatus').value = data.status || 'status-ok';
                document.getElementById('modalBookingType').value = data.booking_type || 'Lesson';
                document.getElementById('modalMemo').value = data.memo || '';

                if (data.students) {
                    const s = data.students;
                    const name = (s.last_name && s.first_name) ? `${s.last_name} ${s.first_name}` : s.name;
                    document.getElementById('selectedStudentId').value = data.student_id;
                    document.getElementById('selectedStudentName').textContent = name;
                }
            } else {
                // Default
                document.getElementById('modalStatus').value = 'status-ok';
                document.getElementById('modalBookingType').value = 'Lesson';
                document.getElementById('modalMemo').value = '';
            }
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').classList.remove('active');
            bookingModalTarget = null;
        }

        async function saveBooking() {
            if (!bookingModalTarget) return;

            const updates = {
                date: bookingModalTarget.date,
                time_code: bookingModalTarget.time, // Using column 'time_code' ?? WAIT. Public uses 'time_code'. 
                // Admin 'schedule_slots' uses 'time'. Check schema. 
                // Step 1503 View File showed: `item.time_code` in PUBLIC script. (Line 299)
                // BUT Step 1439 script used `slot.time`.
                // Schema from Artifacts `supabase_schema`: "time TIME NOT NULL".
                // BUT user might have renamed/added 'time_code'.
                // If I use 'time', Supabase casts to Time type.
                // NOTE: 'schedule_slots' PK is (date, time).
                // I will use 'time'.
                time: bookingModalTarget.time,

                status: document.getElementById('modalStatus').value,
                student_id: document.getElementById('selectedStudentId').value || null,
                booking_type: document.getElementById('modalBookingType').value,
                memo: document.getElementById('modalMemo').value,
                updated_at: new Date().toISOString()
            };

            // UPSERT
            const { error } = await client
                .from('schedule_slots')
                .upsert(updates, { onConflict: 'date, time' });

            if (error) {
                alert("‰øùÂ≠ò„Ç®„É©„Éº: " + error.message);
            } else {
                closeBookingModal();
                fetchSchedule(); // Refresh
            }
        }

        function clearBooking() {
            // "Clear Assignment" Logic
            document.getElementById('selectedStudentId').value = '';
            document.getElementById('selectedStudentName').textContent = '';
            document.getElementById('modalStatus').value = 'status-ok';
            // User must click Save to confirm
        }

        // --- STUDENT SEARCH ---
        async function searchStudents() {
            const term = document.getElementById('studentSearch').value;
            const resultsDiv = document.getElementById('studentSearchResults');

            if (term.length < 1) {
                resultsDiv.style.display = 'none';
                return;
            }

            // JOIN SEARCH ?? No, search 'students' table directly
            const { data, error } = await client
                .from('students')
                .select('id, name, first_name, last_name, alias')
                .or(`name.ilike.%${term}%,first_name.ilike.%${term}%,last_name.ilike.%${term}%`)
                .limit(5);

            resultsDiv.innerHTML = '';
            resultsDiv.style.display = 'block';

            if (data) {
                data.forEach(s => {
                    const div = document.createElement('div');
                    div.style.padding = '8px';
                    div.style.borderBottom = '1px solid #333';
                    div.style.cursor = 'pointer';

                    const nameDisplay = (s.last_name && s.first_name) ? `${s.last_name} ${s.first_name}` : s.name;
                    div.textContent = nameDisplay;
                    div.onclick = () => {
                        document.getElementById('selectedStudentId').value = s.id;
                        document.getElementById('selectedStudentName').textContent = nameDisplay;
                        resultsDiv.style.display = 'none';
                        document.getElementById('studentSearch').value = '';
                    };
                    resultsDiv.appendChild(div);
                });
            }
        }

        // --- UTILS ---
        function formatDateKey(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function updateHeaderDate(start) {
            const end = new Date(start);
            end.setDate(end.getDate() + 6);
            document.querySelector('.current-month').textContent =
                `${start.getFullYear()}.${start.getMonth() + 1} / ${start.getDate()} - ${end.getDate()}`;
        }

        // --- LISTENERS ---
        document.getElementById('prevWeek').onclick = () => {
            currentMonthStart.setDate(currentMonthStart.getDate() - 7);
            init();
        };
        document.getElementById('nextWeek').onclick = () => {
            currentMonthStart.setDate(currentMonthStart.getDate() + 7);
            init();
        };

    </script>
    const SUPABASE_KEY =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwdGVnenp1a3ltcW90emNoZ25wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NDU1MTYsImV4cCI6MjA3OTQyMTUxNn0.iKWkVYwlKrSBlJKUxRebbGRcgvprzkcyAOgDaCHKLSY';

    // --- CONSTANTS ---
    const HOURS = [];
    for (let i = 8; i <= 22; i++) HOURS.push(i + ":00" ); let client; let scheduleData={}; let currentMonthStart=new
        Date(); // Using this as state // --- INIT --- window.onload=function () { console.log("Window Loaded.
        Initializing..."); try { if (typeof supabase==='undefined' ) { throw new Error("Supabase library not loaded"); }
        client=supabase.createClient(SUPABASE_URL, SUPABASE_KEY); console.log("Supabase initialized"); init(); } catch
        (err) { alert("Init Error: " + err.message);
            }
        };

        async function init() {
            renderSkeleton();
            await fetchSchedule();
        }

        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        async function fetchSchedule() {
            try {
                const start = getStartOfWeek(currentMonthStart);
                const end = new Date(start);
                end.setDate(end.getDate() + 6);
                const startStr = start.toISOString().split('T')[0];
                const endStr = end.toISOString().split('T')[0];

                const { data: slots, error } = await client
                    .from('schedule_slots')
                    .select('*')
                    .gte('date', startStr)
                    .lte('date', endStr);

                if (error) throw error;

                scheduleData = {};
                if (slots) {
                    slots.forEach(slot => {
                        const key = `${slot.date}_${slot.time.slice(0, 5)}`;
                        scheduleData[key] = slot;
                    });
                }
                renderSchedule(start);
                updateHeaderDate(start);
            } catch (err) {
                console.error(" Fetch Error:", err); } } function renderSkeleton() { const
        grid=document.getElementById('schedule-grid'); if (!grid) return; grid.innerHTML='' ; const
        headerRow=document.createElement('div'); headerRow.className='schedule-header' ; const
        corner=document.createElement('div'); corner.className='header-corner' ; corner.textContent='Time' ;
        headerRow.appendChild(corner); const start=getStartOfWeek(currentMonthStart); const dates=[]; for (let i=0; i <
        7; i++) { const d=new Date(start); d.setDate(d.getDate() + i); dates.push(d); const
        col=document.createElement('div'); col.className='header-date' ; const dayNames=['Sun', 'Mon' , 'Tue' , 'Wed'
        , 'Thu' , 'Fri' , 'Sat' ]; col.innerHTML=`${dayNames[d.getDay()]}<br><span
            style="font-size:1.2rem">${d.getDate()}</span>`;
        if (d.toDateString() === new Date().toDateString()) col.classList.add('today');
        headerRow.appendChild(col);
        }
        grid.appendChild(headerRow);

        const body = document.createElement('div');
        body.id = 'schedule-body';
        body.className = 'schedule-body';

        HOURS.forEach(time => {
        const row = document.createElement('div');
        row.className = 'schedule-row';
        const label = document.createElement('div');
        label.className = 'time-label';
        label.textContent = time;
        row.appendChild(label);

        dates.forEach(date => {
        const dateKey = formatDateKey(date);
        const slot = document.createElement('div');
        slot.className = 'slot';
        slot.dataset.date = dateKey;
        slot.dataset.time = time;
        slot.onclick = () => openBookingModal(dateKey, time);
        slot.innerHTML = '<span style="color:#666">‚óé</span>';
        row.appendChild(slot);
        });
        body.appendChild(row);
        });
        grid.appendChild(body);
        }

        function formatDateKey(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
        }

        function renderSchedule(start) {
        const slots = document.querySelectorAll('.slot');
        slots.forEach(slot => {
        const key = `${slot.dataset.date}_${slot.dataset.time}`;
        const data = scheduleData[key];

        slot.className = 'slot';
        slot.innerHTML = '';

        if (data) {
        if (data.status === 'status-ng') {
        slot.classList.add('status-ng');
        slot.textContent = '-';
        } else if (data.status === 'status-online') {
        slot.classList.add('status-online');
        slot.textContent = 'Online';
        } else {
        slot.classList.add('status-ok');
        slot.textContent = '‚óé';
        }
        if (data.student_name || data.memo) {
        const info = document.createElement('div');
        info.style.fontSize = '0.7rem';
        info.textContent = data.student_name || 'Memo';
        slot.appendChild(info);
        slot.classList.add('has-booking');
        }
        } else {
        slot.classList.add('status-ok');
        slot.textContent = '‚óé';
        }
        });
        }

        function updateHeaderDate(start) {
        const end = new Date(start);
        end.setDate(end.getDate() + 6);
        document.querySelector('.current-month').textContent =
        `${start.getFullYear()}.${start.getMonth() + 1} / ${start.getDate()} - ${end.getDate()}`;
        }

        document.getElementById('prevWeek').onclick = () => {
        currentMonthStart.setDate(currentMonthStart.getDate() - 7);
        init();
        };
        document.getElementById('nextWeek').onclick = () => {
        currentMonthStart.setDate(currentMonthStart.getDate() + 7);
        init();
        };

        // Modal Stub (Minimal required for onclick)
        function openBookingModal(date, time) {
        // Restore modal logic in next step if verified
        console.log("Open Modal", date, time);
        alert("Modal logic to be restored. Calendar Rendering Verified!");
        }

        </script>

        // 2. CONFIG
        const SUPABASE_URL = 'https://yptegzzukymqotzchgnp.supabase.co';
        const SUPABASE_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwdGVnenp1a3ltcW90emNoZ25wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NDU1MTYsImV4cCI6MjA3OTQyMTUxNn0.iKWkVYwlKrSBlJKUxRebbGRcgvprzkcyAOgDaCHKLSY';

        let client;
        let scheduleData = {};

        // 3. INIT CLIENT SAFELY
        try {
        if (typeof supabase === 'undefined') {
        throw new Error("Supabase Library failed to load.");
        }
        client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log("Supabase Client Init Success");
        } catch (e) {
        alert("Critical Error: " + e.message);
        }

        // --- Bulk Update Logic ---
        async function runBulkUpdate() {
        const startDateStr = document.getElementById('bulkStartDate').value;
        const endDateStr = document.getElementById('bulkEndDate').value;
        const startTimeStr = document.getElementById('bulkStartTime').value;
        const endTimeStr = document.getElementById('bulkEndTime').value;
        const status = document.getElementById('bulkStatus').value;

        if (!startDateStr || !endDateStr) {
        alert("ÊúüÈñì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        return;
        }

        const startHour = parseInt(startTimeStr.split(':')[0]);
        const endHour = parseInt(endTimeStr.split(':')[0]);
        let updates = [];
        let curr = new Date(startDateStr);
        const end = new Date(endDateStr);

        while (curr <= end) { const dateKey=formatDateKey(curr); for (let h=startHour; h <=endHour; h++) {
            updates.push({ date: dateKey, time_code: `${h}:00`, status: status }); } curr.setDate(curr.getDate() + 1); }
            if (updates.length===0) { alert("ÂØæË±°„ÅÆÊû†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì"); return; } if (!confirm(`${updates.length}‰ª∂„ÅÆÊû†„Çí‰∏ÄÊã¨Êõ¥Êñ∞„Åó„Åæ„Åô„ÅãÔºü`))
            return; const { error }=await client.from('schedule_slots').upsert(updates, { onConflict: 'date, time_code'
            }); if (error) { alert("„Ç®„É©„Éº: " + error.message); return; }
            alert(" Êõ¥Êñ∞ÂÆå‰∫ÜÔºÅ"); fetchSchedule(currentStartDate); } let currentStartDate=new Date(); const START_HOUR=8;
            const END_HOUR=22; const HOURS=[]; for (let i=START_HOUR; i <=END_HOUR; i++) { HOURS.push(`${i}:00`); } //
            Init Bulk Selects setTimeout(()=> {
            const bulkStartSelect = document.getElementById('bulkStartTime');
            const bulkEndSelect = document.getElementById('bulkEndTime');
            if (bulkStartSelect && bulkEndSelect) {
            HOURS.forEach(h => {
            const opt1 = document.createElement('option');
            opt1.value = h; opt1.textContent = h;
            bulkStartSelect.appendChild(opt1);
            const opt2 = document.createElement('option');
            opt2.value = h; opt2.textContent = h;
            bulkEndSelect.appendChild(opt2);
            });
            bulkEndSelect.value = "22:00";
            const today = new Date();
            const nextMonth = new Date();
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            document.getElementById('bulkStartDate').value = today.toISOString().split('T')[0];
            document.getElementById('bulkEndDate').value = nextMonth.toISOString().split('T')[0];
            }
            }, 100);

            const formatDateKey = (date) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2,
            '0')}`;
            };

            const formatDisplayDate = (date) => {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            return `${date.getMonth() + 1}/${date.getDate()}<br><span
                style="font-size:0.85em">(${days[date.getDay()]})</span>`;
            };

            const STATUS_TEXT = {
            'status-ok': '‚óé',
            'status-online': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12.55a11 11 0 0 1 14.08 0"></path>
                <path d="M1.42 9a16 16 0 0 1 21.16 0"></path>
                <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
                <line x1="12" y1="20" x2="12.01" y2="20"></line>
            </svg>',
            'status-ng': '-'
            };

            async function fetchSchedule(startDate) {
            console.log("Fetching schedule for:", startDate);
            const dates = [];
            for (let i = 0; i < 7; i++) { const d=new Date(startDate); d.setDate(startDate.getDate() + i);
                dates.push(d); } const dateKeys=dates.map(formatDateKey); // --- 1. RENDER SKELETON (Ensure Height) ---
                const headerContainer=document.querySelector('.schedule-header'); if (headerContainer) {
                headerContainer.innerHTML='' ; const corner=document.createElement('div');
                corner.className='date-col header-corner' ; headerContainer.appendChild(corner); dates.forEach(d=> {
                const div = document.createElement('div');
                div.className = 'date-col';
                if (d.getDay() === 6) div.classList.add('sat');
                if (d.getDay() === 0) div.classList.add('sun');
                div.innerHTML = `<span>${formatDisplayDate(d)}</span>`;
                headerContainer.appendChild(div);
                });
                }

                const bodyContainer = document.getElementById('schedule-body');
                if (bodyContainer) {
                bodyContainer.innerHTML = ''; // Clear prev
                HOURS.forEach(timeCode => {
                const row = document.createElement('div');
                row.className = 'schedule-row';
                const timeLabel = document.createElement('div');
                timeLabel.className = 'time-label';
                timeLabel.textContent = timeCode + '~';
                row.appendChild(timeLabel);

                dates.forEach(d => {
                const dateKey = formatDateKey(d);
                // Placeholder slot
                const div = document.createElement('div');
                div.id = `slot-${dateKey}-${timeCode.replace(':', '')}`;
                div.className = 'slot status-ng'; // Default styling
                div.textContent = '-';
                div.style.cursor = 'wait'; // Loading state
                row.appendChild(div);
                });
                bodyContainer.appendChild(row);
                });
                }
                const monthLabel = document.querySelector('.current-month');
                if (monthLabel) monthLabel.textContent = `${startDate.getFullYear()}Âπ¥ ${startDate.getMonth() + 1}Êúà`;

                // --- 2. FETCH DATA ---
                scheduleData = {};
                try {
                if (!client) throw new Error("Client not initialized");

                const { data: slots, error: slotError } = await client
                .from('schedule_slots')
                .select('*')
                .in('date', dateKeys);

                if (slotError) console.error("Slot Fetch Error:", slotError);

                if (slots) {
                const studentIds = [...new Set(slots.filter(s => s.student_id).map(s => s.student_id))];
                let studentMap = {};
                if (studentIds.length > 0) {
                const { data: students } = await client.from('students').select('*').in('id', studentIds);
                if (students) students.forEach(s => studentMap[s.id] = s);
                }

                // Merge and Update UI
                slots.forEach(item => {
                if (!scheduleData[item.date]) scheduleData[item.date] = {};
                if (item.student_id && studentMap[item.student_id]) {
                item.students = studentMap[item.student_id];
                if (!item.students.last_name && item.students.name) {
                item.students.last_name = item.students.name;
                }
                }
                scheduleData[item.date][item.time_code] = item;

                // Update Slot UI
                const slotId = `slot-${item.date}-${item.time_code.replace(':', '')}`;
                const div = document.getElementById(slotId);
                if (div) {
                // Render logic ... same as before but targeted
                let status = item.status;
                let displayText = STATUS_TEXT[status];
                let slotClass = `slot ${status}`;

                if (item.student_id) {
                slotClass += ' booked';
                status = 'status-booked';
                let sName = "Unknown";
                if (item.students) {
                sName = (item.students.last_name || item.students.first_name)
                ? `${item.students.last_name || ''} ${item.students.first_name || ''}`
                : (item.students.name || 'No Name');
                }
                displayText = `<div style="font-size:0.7em; line-height:1.1; color: var(--primary-neon);">
                    Booked:<br>${sName}</div>`;
                }
                div.className = slotClass;
                div.innerHTML = displayText;
                div.onclick = () => openBookingModal(item.date, item.time_code, item);
                div.style.cursor = 'pointer';
                }
                });
                }
                } catch (e) {
                console.error("Data Load Error", e);
                }

                // --- 3. FINALIZE UI (Add Click Handlers to Empty Slots) ---
                HOURS.forEach(timeCode => {
                dates.forEach(d => {
                const dateKey = formatDateKey(d);
                const slotId = `slot-${dateKey}-${timeCode.replace(':', '')}`;
                const div = document.getElementById(slotId);
                if (div && div.style.cursor === 'wait') {
                // Was not updated/booked -> make it clickable as default/empty
                div.style.cursor = 'pointer';
                div.onclick = () => openBookingModal(dateKey, timeCode, null);
                }
                });
                });
                }

                let bookingModalTarget = null;

                async function openBookingModal(date, time, record) {
                bookingModalTarget = { date, time, record };
                const modal = document.getElementById('bookingModal');
                document.getElementById('modalTitle').textContent = `${date} ${time}`;

                document.getElementById('modalStatus').value = record ? record.status : 'status-ng';
                document.getElementById('selectedStudentId').value = record ? (record.student_id || '') : '';

                const nameDiv = document.getElementById('selectedStudentName');
                if (record && record.students) {
                let sName = (record.students.last_name && record.students.first_name)
                ? `${record.students.last_name} ${record.students.first_name}`
                : (record.students.name || '');
                nameDiv.textContent = `ÈÅ∏Êäû‰∏≠: ${sName}`;
                } else {
                nameDiv.textContent = '';
                }

                document.getElementById('studentSearch').value = '';
                document.getElementById('studentSearchResults').style.display = 'none';
                document.getElementById('modalBookingType').value = record ? (record.booking_type || 'Lesson') :
                'Lesson';
                document.getElementById('modalMemo').value = record ? (record.memo || '') : '';

                modal.classList.add('active');
                }

                function closeBookingModal() {
                document.getElementById('bookingModal').classList.remove('active');
                }

                async function searchStudents() {
                const term = document.getElementById('studentSearch').value;
                if (term.length < 1) { document.getElementById('studentSearchResults').style.display='none' ; return; }
                    const { data, error }=await client .from('students') .select('*')
                    .or(`last_name.ilike.%${term}%,first_name.ilike.%${term}%,name.ilike.%${term}%`) .limit(5); const
                    resultsDiv=document.getElementById('studentSearchResults'); resultsDiv.innerHTML='' ;
                    resultsDiv.style.display='block' ; if (data) { data.forEach(s=> {
                    const div = document.createElement('div');
                    div.style.padding = '8px';
                    div.style.cursor = 'pointer';
                    div.style.borderBottom = '1px solid #444';
                    div.style.color = 'white';

                    const sName = (s.last_name && s.first_name) ? `${s.last_name} ${s.first_name}` : (s.name ||
                    'Unknown');
                    div.textContent = sName;
                    div.onmouseover = () => div.style.background = '#444';
                    div.onmouseout = () => div.style.background = 'transparent';
                    div.onclick = () => {
                    document.getElementById('selectedStudentId').value = s.id;
                    document.getElementById('selectedStudentName').textContent = `ÈÅ∏Êäû‰∏≠: ${sName}`;
                    resultsDiv.style.display = 'none';
                    };
                    resultsDiv.appendChild(div);
                    });
                    }
                    }

                    async function saveBooking() {
                    const status = document.getElementById('modalStatus').value;
                    const studentId = document.getElementById('selectedStudentId').value || null;
                    const type = document.getElementById('modalBookingType').value;
                    const memo = document.getElementById('modalMemo').value;

                    const { date, time } = bookingModalTarget;

                    const updates = {
                    date: date,
                    time_code: time,
                    status: status,
                    student_id: studentId,
                    booking_type: type,
                    memo: memo
                    };

                    const { error } = await client.from('schedule_slots').upsert(updates, { onConflict: 'date,
                    time_code'
                    });
                    if (error) { alert("‰øùÂ≠òÂ§±Êïó: " + error.message); return; }

                    closeBookingModal();
                    fetchSchedule(currentStartDate);
                    }

                    function clearBooking() {
                    document.getElementById('selectedStudentId').value = '';
                    document.getElementById('modalStatus').value = 'status-ok';
                    saveBooking();
                    }

                    document.getElementById('prevWeek').addEventListener('click', () => {
                    const newDate = new Date(currentStartDate);
                    newDate.setDate(newDate.getDate() - 7);
                    currentStartDate = newDate;
                    fetchSchedule(currentStartDate);
                    });
                    document.getElementById('nextWeek').addEventListener('click', () => {
                    const newDate = new Date(currentStartDate);
                    newDate.setDate(newDate.getDate() + 7);
                    currentStartDate = newDate;
                    fetchSchedule(currentStartDate);
                    });

                    // 4. INIT START
                    try {
                    fetchSchedule(currentStartDate);
                    } catch (e) {
                    alert("Init Error: " + e.message);
                    </script>
</body>

</html>