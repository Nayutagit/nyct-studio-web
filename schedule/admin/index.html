<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Schedule | ニストスタジオ</title>
    <link rel="icon" href="../../img/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../../style.css?v=42">
    <script src="https://kit.fontawesome.com/aa13b8dc63.js" crossorigin="anonymous"></script>
    <style>
        .admin-controls {
            margin-bottom: 20px;
            text-align: center;
        }

        .save-status {
            margin-left: 20px;
            color: var(--accent-teal);
            opacity: 0;
            transition: opacity 0.5s;
        }

        .save-status.show {
            opacity: 1;
        }

        .schedule-grid {
            border: 2px solid var(--primary-neon);
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="container header-inner">
            <span class="logo">管理画面</span>
        </div>
    </header>

    <section class="section">
        <div class="container">
            <h1 class="section-title">スケジュール管理</h1>
            <p style="text-align: center; margin-bottom: 20px;">クリックしてステータスを変更（◎ → △ → × → -）</p>

            <!-- Bulk Update UI -->
            <div
                style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; margin-bottom: 30px; text-align: center;">
                <h3 style="margin-bottom: 15px; font-size: 1.2rem; color: var(--primary-neon);">一括更新</h3>
                <div
                    style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; align-items: center; margin-bottom: 15px;">
                    <div>
                        <label>期間:</label>
                        <input type="date" id="bulkStartDate"
                            style="padding: 5px; background: #333; color: white; border: 1px solid #555;">
                        <span>〜</span>
                        <input type="date" id="bulkEndDate"
                            style="padding: 5px; background: #333; color: white; border: 1px solid #555;">
                    </div>
                    <div>
                        <label>時間:</label>
                        <select id="bulkStartTime"
                            style="padding: 5px; background: #333; color: white; border: 1px solid #555;"></select>
                        <span>〜</span>
                        <select id="bulkEndTime"
                            style="padding: 5px; background: #333; color: white; border: 1px solid #555;"></select>
                    </div>
                    <div>
                        <label>ステータス:</label>
                        <select id="bulkStatus"
                            style="padding: 10px; border-radius: 4px; border: 1px solid #444; background: #333; color: white;">
                            <option value="status-ok">◎ 余裕あり</option>
                            <option value="status-online">Online Only</option>
                            <option value="status-ng">- 受付不可</option>
                        </select>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label>曜日:</label>
                    <label><input type="checkbox" name="bulkDay" value="1" checked> 月</label>
                    <label><input type="checkbox" name="bulkDay" value="2" checked> 火</label>
                    <label><input type="checkbox" name="bulkDay" value="3" checked> 水</label>
                    <label><input type="checkbox" name="bulkDay" value="4" checked> 木</label>
                    <label><input type="checkbox" name="bulkDay" value="5" checked> 金</label>
                    <label><input type="checkbox" name="bulkDay" value="6" checked> 土</label>
                    <label><input type="checkbox" name="bulkDay" value="0" checked> 日</label>
                </div>
                <button onclick="applyBulk()" class="cal-btn"
                    style="background: var(--accent-teal-dark); border: none;">一括適用</button>
            </div>

            <!-- AI Update UI -->
            <div
                style="background: rgba(100, 200, 255, 0.05); padding: 20px; border-radius: 8px; margin-bottom: 30px; text-align: center; border: 1px solid var(--accent-teal);">
                <h3 style="margin-bottom: 15px; font-size: 1.2rem; color: var(--accent-teal);">AIで更新 (Gemini)</h3>
                <div style="max-width: 600px; margin: 0 auto;">
                    <input type="password" id="geminiKey" placeholder="Gemini API Key"
                        style="padding: 10px; border-radius: 4px; border: 1px solid #444; background: #333; color: white; width: 300px;">
                    <input type="text" id="geminiModel" placeholder="Model Name (e.g. gemini-2.0-flash)"
                        value="gemini-2.0-flash"
                        style="padding: 10px; border-radius: 4px; border: 1px solid #444; background: #333; color: white; width: 200px; margin-left: 10px;">
                    <textarea id="aiInstruction" placeholder="例: 「来週の月曜と水曜、14時から18時まで満席にして」「12/25の全枠を受付不可に」"
                        style="width: 100%; height: 80px; padding: 8px; background: #222; color: white; border: 1px solid #444; border-radius: 4px; margin-bottom: 10px;"></textarea>
                    <button onclick="runAIUpdate()" id="aiBtn" class="cal-btn"
                        style="background: var(--primary-neon); color: black; border: none; font-weight: bold;">AI実行</button>
                </div>
            </div>

            <div class="calendar-controls">
                <button class="cal-btn" id="prevWeek">前の週</button>
                <h2 class="current-month"></h2>
                <button class="cal-btn" id="nextWeek">次の週</button>
                <span id="saveStatus" class="save-status">保存しました</span>
            </div>

            <div class="schedule-grid">
                <div class="schedule-header">
                    <!-- JS Injected -->
                </div>
                <div id="schedule-body">
                    <!-- JS Injected -->
                </div>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        /*
        const pass = prompt("Password:");
        if (pass !== "Nayuta24!") {
            document.body.innerHTML = "<h1>Access Denied</h1>";
            throw new Error("Access Denied");
        }
        */

        const SUPABASE_URL = 'https://yptegzzukymqotzchgnp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwdGVnenp1a3ltcW90emNoZ25wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NDU1MTYsImV4cCI6MjA3OTQyMTUxNn0.iKWkVYwlKrSBlJKUxRebbGRcgvprzkcyAOgDaCHKLSY';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Load Gemini Key
        const savedKey = localStorage.getItem('gemini_key');
        if (savedKey) document.getElementById('geminiKey').value = savedKey;

        async function runAIUpdate() {
            const key = document.getElementById('geminiKey').value.trim();
            const text = document.getElementById('aiInstruction').value.trim();

            if (!key) { alert("API Keyを入力してください"); return; }
            if (!text) { alert("指示を入力してください"); return; }

            localStorage.setItem('gemini_key', key);

            const btn = document.getElementById('aiBtn');
            const originalText = btn.textContent;
            btn.textContent = "解析中...";
            btn.disabled = true;

            try {
                // Construct Prompt
                const todayStr = new Date().toISOString().split('T')[0];
                const prompt = `
                You are a schedule management assistant.
                Today is ${todayStr}.
                The user wants to update schedule slots.
                Slots are hourly from 10:00 to 22:00.
                Statuses:
                - status-ok (Open/Available)
                - status-few (Few left)
                - status-full (Full/Booked)
                - status-ng (Closed/Not Available)

                Instruction: "${text}"

                Return a JSON ARRAY of objects. Each object must have:
                - "date": "YYYY-MM-DD"
                - "time_code": "HH:MM" (e.g. "10:00", "11:00")
                - "status": "status-..."

                Only return the JSON array. No markdown.
                If instruction implies a range (e.g. 14:00-18:00), generate objects for EACH hour (14:00, 15:00, 16:00, 17:00).
                If instruction says "Next Monday", calculate the date based on Today (${todayStr}).
                `;

                const modelName = document.getElementById('geminiModel').value.trim() || 'gemini-2.0-flash';

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const result = await response.json();

                if (result.error) {
                    // Diagnostic: Check available models if not found
                    if (result.error.code === 404 || result.error.message.includes('not found')) {
                        const listResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                        const listData = await listResp.json();
                        if (listData.models) {
                            const modelNames = listData.models.map(m => m.name.split('/').pop()).join(', ');
                            alert(`指定したAIモデルがあなたのキーで見つかりませんでした。\n利用可能なモデル一覧: ${modelNames}\n\ngemini-proに切り替えて再試行してみてください。`);
                            btn.textContent = 'AI実行 (エラー)';
                            return;
                        }
                    }
                    console.error('Gemini API Error:', result.error);
                    alert(`AIエラー: ${result.error.message}`);
                    btn.textContent = 'AI実行 (エラー)';
                    return;
                }

                const jsonText = result.candidates[0].content.parts[0].text;
                const cleanJson = jsonText.replace(/```json/g, '').replace(/```/g, '').trim();
                const updates = JSON.parse(cleanJson);

                // Confirmation
                if (!confirm(`${updates.length}件の枠を更新します。\n例: ${updates[0].date} ${updates[0].time_code} -> ${updates[0].status}`)) {
                    btn.textContent = originalText; // Revert button text if cancelled
                    btn.disabled = false;
                    return;
                }

                // Execute Upsert using existing client
                const { error } = await client
                    .from('schedule_slots')
                    .upsert(updates, { onConflict: 'date, time_code' });

                if (error) throw error;

                alert("AI更新完了！");
                fetchSchedule(currentStartDate);
                btn.textContent = 'AI実行 (完了)';

            } catch (e) {
                console.error('AI Request Failed:', e);
                alert('AIリクエストに失敗しました: ' + e.message);
                btn.textContent = 'AI実行 (失敗)';
            } finally {
                btn.disabled = false;
            }
        }

        let currentStartDate = new Date();
        const START_HOUR = 10;
        const END_HOUR = 22;
        const HOURS = [];
        for (let i = START_HOUR; i <= END_HOUR; i++) {
            HOURS.push(`${i}:00`);
        }

        // Init Bulk Selects
        const bulkStartSelect = document.getElementById('bulkStartTime');
        const bulkEndSelect = document.getElementById('bulkEndTime');
        HOURS.forEach(h => {
            const opt1 = document.createElement('option');
            opt1.value = h; opt1.textContent = h;
            bulkStartSelect.appendChild(opt1);
            const opt2 = document.createElement('option');
            opt2.value = h; opt2.textContent = h;
            bulkEndSelect.appendChild(opt2);
        });
        bulkEndSelect.value = "22:00";

        // Init Bulk Dates (Default: Today + 1 month)
        const today = new Date();
        const nextMonth = new Date();
        nextMonth.setMonth(nextMonth.getMonth() + 1);
        document.getElementById('bulkStartDate').value = today.toISOString().split('T')[0];
        document.getElementById('bulkEndDate').value = nextMonth.toISOString().split('T')[0];

        const formatDateKey = (date) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        const formatDisplayDate = (date) => {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            return `${date.getMonth() + 1}/${date.getDate()}<br><span style="font-size:0.85em">(${days[date.getDay()]})</span>`;
        };

        const STATUS_ORDER = ['status-ok', 'status-online', 'status-ng'];
        const STATUS_TEXT = {
            'status-ok': '◎',
            'status-online': '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"></path><path d="M1.42 9a16 16 0 0 1 21.16 0"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></svg>',
            'status-ng': '-'
        };

        async function fetchSchedule(startDate) {
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(startDate);
                d.setDate(startDate.getDate() + i);
                dates.push(d);
            }

            // Headers
            const headerContainer = document.querySelector('.schedule-header');
            headerContainer.innerHTML = '';
            const corner = document.createElement('div');
            corner.className = 'date-col header-corner';
            headerContainer.appendChild(corner);

            dates.forEach(d => {
                const div = document.createElement('div');
                div.className = 'date-col';
                if (d.getDay() === 6) div.classList.add('sat');
                if (d.getDay() === 0) div.classList.add('sun');
                div.innerHTML = `<span>${formatDisplayDate(d)}</span>`;
                headerContainer.appendChild(div);
            });

            // Right Corner
            const cornerRight = document.createElement('div');
            cornerRight.className = 'date-col header-corner header-corner-right';
            headerContainer.appendChild(cornerRight);

            // Data
            const dateKeys = dates.map(formatDateKey);
            let dataMap = {};

            const { data, error } = await client
                .from('schedule_slots')
                .select('*')
                .in('date', dateKeys);

            if (data && !error) {
                data.forEach(item => {
                    if (!dataMap[item.date]) dataMap[item.date] = {};
                    dataMap[item.date][item.time_code] = item.status;
                });
            }

            // Body
            const bodyContainer = document.getElementById('schedule-body');
            bodyContainer.innerHTML = '';

            HOURS.forEach(timeCode => {
                const row = document.createElement('div');
                row.className = 'schedule-row';

                const timeLabel = document.createElement('div');
                timeLabel.className = 'time-label';
                timeLabel.textContent = timeCode;
                row.appendChild(timeLabel);

                dates.forEach(d => {
                    const dateKey = formatDateKey(d);
                    let status = 'status-ok';
                    if (dataMap[dateKey] && dataMap[dateKey][timeCode]) {
                        status = dataMap[dateKey][timeCode];
                    }

                    const div = document.createElement('div');
                    div.className = `slot ${status}`;
                    div.innerHTML = STATUS_TEXT[status];
                    div.style.cursor = 'pointer';
                    div.onclick = () => toggleStatus(div, dateKey, timeCode);
                    row.appendChild(div);
                });

                // Right Time Label
                const timeLabelRight = document.createElement('div');
                timeLabelRight.className = 'time-label time-label-right';
                timeLabelRight.textContent = timeCode;
                row.appendChild(timeLabelRight);

                bodyContainer.appendChild(row);
            });

            document.querySelector('.current-month').textContent = `${startDate.getFullYear()}年 ${startDate.getMonth() + 1}月`;
        }

        async function toggleStatus(element, date, time) {
            let currentStatus = 'status-ok';
            if (element.classList.contains('status-online')) currentStatus = 'status-online';
            if (element.classList.contains('status-few')) currentStatus = 'status-few';
            if (element.classList.contains('status-full')) currentStatus = 'status-full';
            if (element.classList.contains('status-ng')) currentStatus = 'status-ng';

            const currentIndex = STATUS_ORDER.indexOf(currentStatus);
            const nextIndex = (currentIndex + 1) % STATUS_ORDER.length;
            const nextStatus = STATUS_ORDER[nextIndex];

            // Optimistic update
            element.className = `slot ${nextStatus}`;
            element.innerHTML = STATUS_TEXT[nextStatus];

            // Save
            const { error } = await client
                .from('schedule_slots')
                .upsert({
                    date: date,
                    time_code: time,
                    status: nextStatus
                }, { onConflict: 'date, time_code' });

            if (error) {
                console.error('Error saving:', error);
                alert('保存エラー: ' + (error.message || JSON.stringify(error)) + '\n\nSupabaseのRLS設定を確認してください。');
                // Revert
                element.className = `slot ${currentStatus}`;
                element.innerHTML = STATUS_TEXT[currentStatus];
            } else {
                showSaveStatus();
            }
        }

        async function applyBulk() {
            const startDateStr = document.getElementById('bulkStartDate').value;
            const endDateStr = document.getElementById('bulkEndDate').value;
            const startTimeStr = document.getElementById('bulkStartTime').value;
            const endTimeStr = document.getElementById('bulkEndTime').value;
            const status = document.getElementById('bulkStatus').value;

            const daysChecked = Array.from(document.querySelectorAll('input[name="bulkDay"]:checked')).map(cb => parseInt(cb.value));

            if (!startDateStr || !endDateStr) {
                alert("期間を指定してください");
                return;
            }

            const start = new Date(startDateStr);
            const end = new Date(endDateStr);
            const items = [];

            // Loop Dates
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                if (daysChecked.includes(d.getDay())) {
                    const dateKey = formatDateKey(d);

                    // Loop Hours
                    let startH = parseInt(startTimeStr.split(':')[0]);
                    let endH = parseInt(endTimeStr.split(':')[0]);

                    for (let h = startH; h <= endH; h++) {
                        items.push({
                            date: dateKey,
                            time_code: `${h}:00`,
                            status: status
                        });
                    }
                }
            }

            if (items.length === 0) {
                alert("対象の枠がありません");
                return;
            }

            if (!confirm(`${items.length}件の枠を一括更新しますか？`)) return;

            // Batch Upsert
            const { error } = await client
                .from('schedule_slots')
                .upsert(items, { onConflict: 'date, time_code' });

            if (error) {
                console.error('Bulk Error:', error);
                alert('一括更新エラー: ' + (error.message || JSON.stringify(error)) + '\n\nSupabaseのRLS設定を確認してください。');
            } else {
                alert('一括更新完了しました');
                fetchSchedule(currentStartDate);
            }
        }

        function showSaveStatus() {
            const el = document.getElementById('saveStatus');
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 2000);
        }

        document.getElementById('prevWeek').addEventListener('click', () => {
            const newDate = new Date(currentStartDate);
            newDate.setDate(newDate.getDate() - 7);
            currentStartDate = newDate;
            fetchSchedule(currentStartDate);
        });
        document.getElementById('nextWeek').addEventListener('click', () => {
            const newDate = new Date(currentStartDate);
            newDate.setDate(newDate.getDate() + 7);
            currentStartDate = newDate;
            fetchSchedule(currentStartDate);
        });

        // Init
        fetchSchedule(currentStartDate);
    </script>
</body>

</html>