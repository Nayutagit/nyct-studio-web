<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Schedule | ニストスタジオ</title>
    <link rel="icon" href="../../img/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=Zen+Kaku+Gothic+New:wght@300;400;500;700;900&family=Zen+Old+Mincho:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../style.css?v=6">
    <style>
        /* Admin Specific Styles */
        .admin-badge {
            font-size: 0.8rem;
            background: var(--primary-neon);
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 10px;
            vertical-align: middle;
        }

        .bulk-update-section {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 40px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .bulk-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-items: flex-end;
        }

        .bulk-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            text-align: left;
        }

        .bulk-group label {
            font-size: 0.8rem;
            color: var(--text-gray);
        }

        .bulk-input {
            padding: 8px 12px;
            background: #222;
            border: 1px solid #444;
            color: white;
            border-radius: 4px;
        }

        /* Forced Grid Styles to prevent layout breakage */
        .schedule-grid {
            /* Ensure it's visible */
            display: block !important;
            overflow-x: auto;
            background: #1e1e1e;
        }

        .schedule-header {
            display: flex !important;
            width: max-content;
            border-bottom: 2px solid #555;
            z-index: 20;
        }

        .schedule-row {
            display: flex !important;
            width: max-content;
            border-bottom: 1px solid #333;
            /* Force visibility */
            opacity: 1 !important;
        }

        .date-col {
            width: 100px !important;
            flex-shrink: 0 !important;
            text-align: center;
            padding: 10px;
            border-right: 1px solid #333;
            background: #252525;
            color: white;
        }

        .header-corner {
            width: 70px !important;
            background: #222;
            position: sticky;
            left: 0;
            z-index: 30;
        }

        .time-label {
            width: 70px !important;
            flex-shrink: 0 !important;
            background: #222;
            color: var(--primary-neon);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            border-right: 2px solid #555;
            position: sticky;
            left: 0;
            z-index: 10;
        }

        .slot {
            width: 100px !important;
            flex-shrink: 0 !important;
            height: 60px !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
            background: #1a1a1a;
            border-right: 1px solid #333;
            cursor: pointer;
            color: white;
            /* Ensure text matches */
        }

        .slot:hover {
            background: #2a2a2a;
        }

        .slot.booked {
            background: rgba(0, 164, 216, 0.15);
            border-color: var(--accent-teal);
        }

        /* Modal Override */
        .modal-overlay.active {
            display: flex;
        }

        /* --- New Light Theme Overrides & One-Touch --- */
        body {
            background-image: none !important;
            background-color: #f4f4f9 !important;
            /* Bright gray */
            color: #333 !important;
        }

        /* Override dark sections */
        .bg-dark-concrete {
            background: transparent !important;
        }

        .header {
            background: #222 !important;
            /* Keep header dark for contrast or make light? Stick to dark menu is often safer for branding, but user said 'bright gray background' for the screen. Let's keep header dark for admin distinction or make it white. Let's try dark header, light body. */
        }

        .page-hero {
            background: #fff;
            border-bottom: 1px solid #ddd;
            color: #333;
        }

        .page-title {
            color: #333;
            text-shadow: none !important;
        }

        .page-title::after {
            box-shadow: none !important;
        }

        .section-subtitle {
            text-shadow: none !important;
        }

        /* Light Grid Styles */
        .schedule-grid {
            background: #fff !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #ddd;
        }

        .schedule-header {
            border-bottom: 2px solid #ccc !important;
            background: #f8f8f8;
        }

        .schedule-row {
            border-bottom: 1px solid #eee !important;
        }

        .date-col {
            background: #f0f0f0 !important;
            color: #333 !important;
            border-right: 1px solid #ddd !important;
            font-weight: bold;
        }

        .date-col.sat {
            color: #00A4D8 !important;
            background: #eef9fd !important;
        }

        .date-col.sun {
            color: #ff4444 !important;
            background: #ffeeee !important;
        }

        .header-corner {
            background: #e0e0e0 !important;
        }

        .time-label {
            background: #fafafa !important;
            color: #666 !important;
            border-right: 2px solid #ddd !important;
        }

        .slot {
            background: #fff !important;
            color: #333 !important;
            border-right: 1px solid #f0f0f0 !important;
        }

        .slot:hover {
            background: #f0f0f0 !important;
        }

        /* Status colors in light mode */
        .slot.booked {
            background: rgba(0, 164, 216, 0.1) !important;
            border-left: 3px solid var(--accent-teal);
        }

        /* Bulk & Inputs Light Mode */
        .bulk-update-section {
            background: #fff !important;
            border: 1px solid #ddd !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03) !important;
        }

        .bulk-update-section h3 {
            color: #333 !important;
        }

        .bulk-group label {
            color: #555 !important;
        }

        .bulk-input,
        .form-input,
        .form-textarea {
            background: #fff !important;
            color: #333 !important;
            border: 1px solid #ccc !important;
        }

        .bulk-input:focus,
        .form-input:focus,
        .form-textarea:focus {
            border-color: var(--primary-neon) !important;
            outline: none;
        }

        /* One Touch Toggle Switch */
        .switch-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #fff;
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid #ddd;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary-neon);
        }

        input:focus+.slider {
            box-shadow: 0 0 1px var(--primary-neon);
        }

        input:checked+.slider:before {
            -webkit-transform: translateX(24px);
            -ms-transform: translateX(24px);
            transform: translateX(24px);
        }

        .toggle-label {
            font-weight: bold;
            color: #333;
            font-size: 0.9rem;
        }

        /* Fixed Toggle in Bottom Right */
        .switch-container-fixed {
            position: fixed !important;
            bottom: 20px !important;
            right: 20px !important;
            display: flex;
            align-items: center;
            gap: 10px;
            background: #fff;
            padding: 12px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 1px solid #ddd;
            z-index: 9999 !important;
        }

        /* Modal Light */
        .modal-content {
            background: #fff !important;
            border: 1px solid #eee !important;
            color: #333 !important;
        }

        #modalTitle {
            color: #333 !important;
        }

        .form-label {
            color: #555 !important;
        }

        .modal-close {
            color: #999 !important;
            top: -40px;
        }

        .modal-close:hover {
            color: #333 !important;
        }

        /* Legend text */
        .calendar-legend {
            color: #333;
        }
    </style>
</head>

<body>

    <!-- Header -->
    <header class="header">
        <div class="container header-inner">
            <a href="../../index.html" class="logo">
                <img src="../../img/logo_white.png" alt="Nyct Studio Logo">
                ニストスタジオ <span class="admin-badge">ADMIN</span>
            </a>
            <nav>
                <ul class="nav-list">
                    <li><a href="index.html" class="nav-link active">Schedule</a></li>
                    <li><a href="students.html" class="nav-link">Students</a></li>
                    <li><a href="../../index.html" class="nav-link" style="color:#666;">Exit</a></li>
                </ul>
                <div class="menu-toggle"><i class="fas fa-bars"></i></div>
            </nav>
        </div>
    </header>

    <!-- Page Hero -->
    <section class="page-hero" style="padding-bottom: 60px;">
        <div class="container page-hero-content">
            <span class="section-subtitle">ADMINISTRATION</span>
            <h1 class="page-title">LESSON MANAGER</h1>
        </div>
    </section>

    <!-- Calendar Section -->
    <section class="section bg-dark-concrete" style="padding-top: 40px;">
        <div class="container">

            <!-- Bulk Update UI -->
            <div class="bulk-update-section fade-in-up">
                <h3 style="color:white; margin-bottom:20px; text-align:center; font-size:1.2rem;">
                    <i class="fas fa-layer-group" style="color:var(--primary-neon);"></i> 一括更新 / Bulk Update
                </h3>
                <div class="bulk-controls">
                    <div class="bulk-group">
                        <label>期間 (Start ~ End)</label>
                        <div style="display:flex; gap:5px; align-items:center;">
                            <input type="date" id="bulkStartDate" class="bulk-input">
                            <span>~</span>
                            <input type="date" id="bulkEndDate" class="bulk-input">
                        </div>
                    </div>
                    <div class="bulk-group">
                        <label>時間帯 (Time)</label>
                        <div style="display:flex; gap:5px; align-items:center;">
                            <select id="bulkStartTime" class="bulk-input"></select>
                            <span>~</span>
                            <select id="bulkEndTime" class="bulk-input"></select>
                        </div>
                    </div>
                    <div class="bulk-group">
                        <label>ステータス</label>
                        <select id="bulkStatus" class="bulk-input" style="min-width:120px;">
                            <option value="status-ok">◎ 予約可能</option>
                            <option value="status-online">Online Only</option>
                            <option value="status-ng">- 受付不可</option>
                        </select>
                    </div>
                    <button onclick="runBulkUpdate()" class="btn btn-primary"
                        style="padding: 8px 25px; font-size:0.9rem;">適用</button>
                </div>
            </div>

            <div class="calendar-controls">
                <button class="cal-btn" id="prevWeek"><i class="fas fa-chevron-left"></i> 前の週</button>
                <h2 class="current-month" style="color:#333;">--</h2>
                <button class="cal-btn" id="nextWeek">次の週 <i class="fas fa-chevron-right"></i></button>
            </div>

            <!-- One Touch Toggle (Fixed Bottom Right) -->
            <div class="switch-container-fixed">
                <label class="switch">
                    <input type="checkbox" id="oneTouchMode">
                    <span class="slider"></span>
                </label>
                <span class="toggle-label">ワンタッチ編集</span>
            </div>

            <div class="calendar-legend">
                <div class="legend" style="margin-top: 20px;">
                    <span class="status-ok">◎</span> 予約可能
                    <span class="status-online" style="margin-left: 10px;"><i class="fa-solid fa-wifi"></i></span>
                    Online
                    <span class="status-few" style="margin-left: 10px;">△</span> 残りわずか
                    <span style="margin-left: 10px; color:#666;">-</span> 不可
                    <span style="margin-left: 10px; color:var(--accent-teal);">■</span> Booked
                </div>
            </div>

            <div class="schedule-grid">
                <div class="schedule-header">
                    <!-- JS Injected -->
                </div>
                <!-- Hourly Grid Body -->
                <div id="schedule-body">
                    <!-- JS Injected -->
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="copyright">
                &copy; 2025 Nyct Studio Admin Console.
            </div>
        </div>
    </footer>

    <!-- Admin Booking Modal -->
    <div class="modal-overlay" id="bookingModal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" onclick="closeBookingModal()"><i class="fas fa-times"></i></button>
            <h3
                style="color: var(--primary-neon); margin-bottom: 20px; font-family: var(--font-serif); text-align:center;">
                スロット編集
            </h3>

            <div class="booking-info">
                <h4 id="modalTitle" style="color: white;"></h4>
            </div>

            <div class="form-group">
                <label class="form-label">ステータス (Status)</label>
                <select id="modalStatus" class="form-input">
                    <option value="status-ok">◎ 予約可能</option>
                    <option value="status-online">Online Only</option>
                    <option value="status-ng">- 受付不可</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">生徒割り当て (Student)</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="studentSearch" class="form-input" placeholder="名前で検索..."
                        oninput="searchStudents()">
                    <input type="hidden" id="selectedStudentId">
                </div>
                <div id="studentSearchResults"
                    style="max-height: 150px; overflow-y: auto; margin-top: 5px; background: #333; border: 1px solid #555; display: none;">
                </div>
                <div id="selectedStudentName" class="booking-info"
                    style="margin-top: 10px; color: var(--accent-teal); font-weight: bold; background:rgba(0,0,0,0.3);">
                    未選択
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Booking Type</label>
                <select id="modalBookingType" class="form-input">
                    <option value="Lesson">Lesson</option>
                    <option value="Counseling">Counseling</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">メモ (Memo)</label>
                <textarea id="modalMemo" class="form-textarea" rows="3"></textarea>
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 30px; gap: 20px;">
                <button class="btn btn-secondary" style="flex:1;" onclick="clearBooking()">割り当て解除</button>
                <button class="btn btn-primary" style="flex:1;" onclick="saveBooking()">保存</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // --- 1. CONFIG & INIT ---
        const SUPABASE_URL = 'https://yptegzzukymqotzchgnp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwdGVnenp1a3ltcW90emNoZ25wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NDU1MTYsImV4cCI6MjA3OTQyMTUxNn0.iKWkVYwlKrSBlJKUxRebbGRcgvprzkcyAOgDaCHKLSY';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentStartDate = new Date();
        let scheduleData = {};
        let bookingModalTarget = null;

        const STATUS_TEXT = {
            'status-ok': '<span style="color:#000; font-weight:bold; font-size:1.2rem;">◎</span>',
            'status-online': '<span style="color:var(--accent-teal); font-weight:bold; font-size:0.9rem;">Online only</span>',
            'status-few': '△',
            'status-full': '×',
            'status-ng': '<span style="color:#ccc;">-</span>',
            'status-booked': 'Booked'
        };

        const START_HOUR = 8;
        const END_HOUR = 22;
        const HOURS = [];
        for (let i = START_HOUR; i <= END_HOUR; i++) {
            HOURS.push(`${i}:00`);
        }

        // --- 2. HELPERS ---
        const formatDateKey = (date) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        const formatDisplayDate = (date) => {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            return `${date.getMonth() + 1}/${date.getDate()}<br><span style="font-size:0.85em">(${days[date.getDay()]})</span>`;
        };

        // --- 3. FETCH & RENDER ---
        async function fetchSchedule(startDate) {
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(startDate);
                d.setDate(startDate.getDate() + i);
                dates.push(d);
            }

            // Headers
            const headerContainer = document.querySelector('.schedule-header');
            headerContainer.innerHTML = '';
            const corner = document.createElement('div');
            corner.className = 'date-col header-corner';
            headerContainer.appendChild(corner);

            dates.forEach(d => {
                const div = document.createElement('div');
                div.className = 'date-col';
                if (d.getDay() === 6) div.classList.add('sat');
                if (d.getDay() === 0) div.classList.add('sun');
                div.innerHTML = `<span>${formatDisplayDate(d)}</span>`;
                headerContainer.appendChild(div);
            });

            // Data Fetch
            const dateKeys = dates.map(formatDateKey);
            scheduleData = {};

            try {
                const { data: slots } = await client
                    .from('schedule_slots')
                    .select('*')
                    .in('date', dateKeys);

                if (slots) {
                    const studentIds = [...new Set(slots.filter(s => s.student_id).map(s => s.student_id))];
                    let studentMap = {};

                    if (studentIds.length > 0) {
                        const { data: students } = await client
                            .from('students')
                            .select('*')
                            .in('id', studentIds);
                        if (students) students.forEach(s => studentMap[s.id] = s);
                    }

                    slots.forEach(item => {
                        if (!scheduleData[item.date]) scheduleData[item.date] = {};
                        if (item.student_id && studentMap[item.student_id]) {
                            item.students = studentMap[item.student_id];
                            if (!item.students.last_name && item.students.name) {
                                item.students.last_name = item.students.name;
                            }
                        }
                        scheduleData[item.date][item.time_code] = item;
                    });
                }
            } catch (e) {
                console.error("Fetch Error:", e);
            }

            // Render Grid
            const bodyContainer = document.getElementById('schedule-body');
            bodyContainer.innerHTML = '';

            HOURS.forEach(timeCode => {
                const row = document.createElement('div');
                row.className = 'schedule-row';

                const timeLabel = document.createElement('div');
                timeLabel.className = 'time-label';
                timeLabel.textContent = timeCode + '~';
                row.appendChild(timeLabel);

                dates.forEach(d => {
                    const dateKey = formatDateKey(d);
                    const record = scheduleData[dateKey] ? scheduleData[dateKey][timeCode] : null;

                    let status = record ? record.status : 'status-ng';
                    let slotClass = `slot ${status}`;
                    let displayText = STATUS_TEXT[status];

                    if (record && record.student_id) {
                        slotClass += ' booked';
                        let sName = "Unknown";
                        if (record.students) {
                            sName = (record.students.last_name && record.students.first_name)
                                ? `${record.students.last_name} ${record.students.first_name}`
                                : (record.students.name || "No Name");
                        }
                        displayText = `<div style="font-size:0.75rem; line-height:1.2; color:var(--primary-neon);">
                            <i class="fas fa-user-circle"></i><br>${sName}
                        </div>`;
                    }

                    const div = document.createElement('div');
                    div.className = slotClass;
                    div.innerHTML = displayText;
                    div.style.cursor = 'pointer';
                    div.onclick = () => handleSlotClick(dateKey, timeCode, record, status);

                    row.appendChild(div);
                });

                bodyContainer.appendChild(row);
            });

            const title = document.querySelector('.current-month');
            title.textContent = `${startDate.getFullYear()}年 ${startDate.getMonth() + 1}月`;
        }

        // --- 4. MODAL LOGIC (ADMIN) ---
        function openBookingModal(date, time, record) {
            bookingModalTarget = { date, time, record };
            const modal = document.getElementById('bookingModal');
            document.getElementById('modalTitle').textContent = `${date} ${time}`;

            document.getElementById('modalStatus').value = record ? record.status : 'status-ng';
            document.getElementById('selectedStudentId').value = record ? (record.student_id || '') : '';
            document.getElementById('modalBookingType').value = record ? (record.booking_type || 'Lesson') : 'Lesson';
            document.getElementById('modalMemo').value = record ? (record.memo || '') : '';

            const nameDiv = document.getElementById('selectedStudentName');
            if (record && record.students) {
                let sName = (record.students.last_name && record.students.first_name)
                    ? `${record.students.last_name} ${record.students.first_name}`
                    : (record.students.name || 'Unknown');
                nameDiv.textContent = `選択中: ${sName}`;
            } else {
                nameDiv.textContent = '未選択';
            }

            document.getElementById('studentSearch').value = '';
            document.getElementById('studentSearchResults').style.display = 'none';

            modal.classList.add('active');
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').classList.remove('active');
        }

        async function searchStudents() {
            const term = document.getElementById('studentSearch').value;
            if (term.length < 1) {
                document.getElementById('studentSearchResults').style.display = 'none';
                return;
            }

            const { data, error } = await client
                .from('students')
                .select('*')
                .or(`last_name.ilike.%${term}%,first_name.ilike.%${term}%,name.ilike.%${term}%`)
                .limit(5);

            const resultsDiv = document.getElementById('studentSearchResults');
            resultsDiv.innerHTML = '';
            resultsDiv.style.display = 'block';

            if (data) {
                data.forEach(s => {
                    const div = document.createElement('div');
                    div.style.padding = '10px';
                    div.style.cursor = 'pointer';
                    div.style.borderBottom = '1px solid #444';
                    div.style.color = 'white';
                    div.style.fontSize = '0.9rem';

                    const sName = (s.last_name && s.first_name) ? `${s.last_name} ${s.first_name}` : (s.name || 'Unknown');
                    div.textContent = sName;

                    div.onmouseover = () => div.style.background = '#444';
                    div.onmouseout = () => div.style.background = 'transparent';

                    div.onclick = () => {
                        document.getElementById('selectedStudentId').value = s.id;
                        document.getElementById('selectedStudentName').textContent = `選択中: ${sName}`;
                        resultsDiv.style.display = 'none';
                    };
                    resultsDiv.appendChild(div);
                });
            }
        }

        async function saveBooking() {
            const status = document.getElementById('modalStatus').value;
            const studentId = document.getElementById('selectedStudentId').value || null;
            const type = document.getElementById('modalBookingType').value;
            const memo = document.getElementById('modalMemo').value;
            const { date, time } = bookingModalTarget;

            const updates = {
                date: date,
                time_code: time,
                status: status,
                student_id: studentId,
                booking_type: type,
                memo: memo
            };

            const { error } = await client.from('schedule_slots').upsert(updates, { onConflict: 'date, time_code' });
            if (error) { alert("Error: " + error.message); return; }

            closeBookingModal();
            fetchSchedule(currentStartDate);
        }

        function clearBooking() {
            document.getElementById('selectedStudentId').value = '';
            document.getElementById('selectedStudentName').textContent = '未選択';
            document.getElementById('modalStatus').value = 'status-ok';
        }

        // --- NEW: HANDLE CLICK (ONE TOUCH vs MODAL) ---
        async function handleSlotClick(date, time, record, currentStatus) {
            const isOneTouch = document.getElementById('oneTouchMode').checked;

            if (isOneTouch) {
                // Determine next status
                // Cycle: OK -> Online -> NG -> OK
                let nextStatus = 'status-ok';
                if (currentStatus === 'status-ok') nextStatus = 'status-online';
                else if (currentStatus === 'status-online') nextStatus = 'status-ng';
                else if (currentStatus === 'status-ng') nextStatus = 'status-ok';
                else nextStatus = 'status-ok'; // Default fallback

                // If currently booked, maybe confirm or warn? 
                // Creating a special case: if it has a student, maybe don't toggle easily?
                // For now, if "Booked", currentStatus comes from STATUS_TEXT mapping logic which is 'status-booked' (implicitly handled in render loop), 
                // but 'record.status' is the underlying DB status.
                // Re-calculating status from record for safety:
                let dbStatus = record ? record.status : 'status-ng';
                if (record && record.student_id) {
                    if (!confirm("予約が入っていますが変更しますか？\n(予約は解除されます)")) return;
                    // Proceed to overwrite
                }

                // If we determined next status based on DB status:
                // If dbStatus == 'status-ok' -> 'status-online'
                // If dbStatus == 'status-online' -> 'status-ng'
                // Else -> 'status-ok'

                if (dbStatus === 'status-ok') nextStatus = 'status-online';
                else if (dbStatus === 'status-online') nextStatus = 'status-ng';
                else nextStatus = 'status-ok';

                // Optimistic UI Update (optional, but fetch is safer)
                // UPSERT
                const updates = {
                    date: date,
                    time_code: time,
                    status: nextStatus,
                    student_id: null, // Clear student if any, as this is "status" toggle
                    booking_type: null,
                    memo: null
                };

                try {
                    const { error } = await client.from('schedule_slots').upsert(updates, { onConflict: 'date, time_code' });
                    if (error) {
                        alert("Update failed: " + error.message);
                        console.error(error);
                    } else {
                        // Success - refresh
                        // To promote "edit mode" feeling, maybe we don't reload whole grid but just cell? 
                        // For simplicity/reliability, fetchSchedule.
                        fetchSchedule(currentStartDate);
                    }
                } catch (e) {
                    console.error("Connection error:", e);
                    alert("Network error occurred.");
                }

            } else {
                openBookingModal(date, time, record);
            }
        }

        async function runBulkUpdate() {
            const startDateStr = document.getElementById('bulkStartDate').value;
            const endDateStr = document.getElementById('bulkEndDate').value;
            const startTimeStr = document.getElementById('bulkStartTime').value;
            const endTimeStr = document.getElementById('bulkEndTime').value;
            const status = document.getElementById('bulkStatus').value;

            if (!startDateStr || !endDateStr) {
                alert("期間を選択してください");
                return;
            }

            if (!confirm("一括更新を行いますか？")) return;

            const startHour = parseInt(startTimeStr.split(':')[0]);
            const endHour = parseInt(endTimeStr.split(':')[0]);
            let updates = [];
            let curr = new Date(startDateStr);
            const end = new Date(endDateStr);

            while (curr <= end) {
                const dateKey = formatDateKey(curr);
                for (let h = startHour; h <= endHour; h++) {
                    updates.push({
                        date: dateKey,
                        time_code: `${h}:00`,
                        status: status
                    });
                }
                curr.setDate(curr.getDate() + 1);
            }

            const { error } = await client.from('schedule_slots').upsert(updates, { onConflict: 'date, time_code' });
            if (error) { alert("Error: " + error.message); return; }

            alert("更新完了しました");
            fetchSchedule(currentStartDate);
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchSchedule(currentStartDate);

            document.getElementById('prevWeek').addEventListener('click', () => {
                const newDate = new Date(currentStartDate);
                newDate.setDate(newDate.getDate() - 7);
                currentStartDate = newDate;
                fetchSchedule(currentStartDate);
            });
            document.getElementById('nextWeek').addEventListener('click', () => {
                const newDate = new Date(currentStartDate);
                newDate.setDate(newDate.getDate() + 7);
                currentStartDate = newDate;
                fetchSchedule(currentStartDate);
            });

            const bulkStartSelect = document.getElementById('bulkStartTime');
            const bulkEndSelect = document.getElementById('bulkEndTime');
            HOURS.forEach(h => {
                bulkStartSelect.add(new Option(h, h));
                bulkEndSelect.add(new Option(h, h));
            });
            bulkEndSelect.value = "22:00";

            const today = new Date();
            const nextMonth = new Date();
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            document.getElementById('bulkStartDate').value = today.toISOString().split('T')[0];
            document.getElementById('bulkEndDate').value = nextMonth.toISOString().split('T')[0];

            const menuToggle = document.querySelector('.menu-toggle');
            const navList = document.querySelector('.nav-list');
            if (menuToggle && navList) {
                menuToggle.addEventListener('click', () => {
                    navList.classList.toggle('active');
                });
            }
        });
    </script>
</body>

</html>