<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Udatsu Instagram Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=Zen+Kaku+Gothic+New:wght@300;400;500;700;900&family=Zen+Old+Mincho:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="udatsu_insta.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* Export Mode Styles */
        body.export-mode .editor-panel {
            display: none;
        }

        body.export-mode .preview-panel {
            background: #222;
            padding: 50px;
            overflow-y: auto;
            display: block;
            /* Allow vertical scrolling */
        }

        body.export-mode .slides-container {
            transform: none !important;
            /* Reset zoom */
            flex-wrap: wrap;
            justify-content: center;
            gap: 40px;
            width: 100%;
            height: auto;
        }

        body.export-mode .slide {
            margin-bottom: 40px;
            /* Ensure high quality rendering */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        /* Export Controls */
        .export-controls {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #333;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            gap: 10px;
        }

        body.export-mode .export-controls {
            display: flex;
        }

        /* Add Slide Button */
        .add-slide-btn {
            background: #333;
            color: #fff;
            border: 1px dashed #666;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            margin-top: 20px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .add-slide-btn:hover {
            background: #444;
            border-color: #888;
        }
    </style>
</head>

<body>

    <div class="app-container">
        <!-- Editor Panel -->
        <div class="editor-panel">
            <div class="editor-header">
                <h1>Udatsu Post Gen</h1>
                <p style="font-size: 0.8rem; color: #888;">Create up to 10 slides</p>
                <button class="btn btn-secondary" onclick="toggleExportMode()">
                    <i class="fas fa-images"></i> Image Export Mode
                </button>
            </div>

            <!-- Global Settings -->
            <div class="control-group">
                <h3 onclick="toggleGroup(this)">Global Settings <i class="fas fa-chevron-down"></i></h3>
                <div class="inputs-content">
                    <label>Font Scale (全体)</label>
                    <input type="range" min="0.5" max="2" step="0.1" value="1.3"
                        oninput="updateGlobalStyle('font-scale', this.value)">
                    <span id="font-scale-value">1.3</span>

                    <label>Overlay Darkness (背景暗さ)</label>
                    <input type="range" min="0" max="0.8" step="0.05" value="0.45"
                        oninput="updateGlobalStyle('overlay-opacity', this.value)">
                    <span id="overlay-opacity-value">0.45</span>

                    <label>Background Image Opacity (画像の透明度)</label>
                    <input type="range" min="0.2" max="1" step="0.05" value="0.5"
                        oninput="updateGlobalStyle('bg-opacity', this.value)">
                    <span id="bg-opacity-value">0.5</span>
                </div>
            </div>

            <!-- Slide Inputs Generated by JS -->
            <div id="slide-inputs">
                <!-- Will be populated by JS -->
            </div>

            <div class="add-slide-btn" onclick="addSlide()">
                <i class="fas fa-plus"></i> Add New Slide
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="preview-panel" id="preview-panel">
            <div class="slides-container" id="slides-container">
                <!-- Slides will be rendered here -->
            </div>
        </div>

        <!-- Zoom Controls (Hidden in Export Mode) -->
        <div class="zoom-controls" id="zoom-controls">
            <button class="btn btn-secondary" onclick="changeZoom(-0.1)">-</button>
            <span id="zoom-level" style="color: white; align-self: center;">30%</span>
            <button class="btn btn-secondary" onclick="changeZoom(0.1)">+</button>
        </div>

        <!-- Export Controls -->
        <div class="export-controls">
            <button class="btn btn-secondary" onclick="toggleExportMode()">
                <i class="fas fa-edit"></i> Back to Editor
            </button>
            <button class="btn" onclick="downloadAllImages()">
                <i class="fas fa-download"></i> Download All
            </button>
        </div>
    </div>

    <script>
        // Default Data
        let slidesData = [
            {
                type: 'cover',
                tag: 'うだつの上がらないあなたへ',
                title: '今日も動画を眺めて\n1日が終わりましたか？',
                text: 'そのスクロール、いつまで続けますか？\n「稼がないとやばい」と焦りながら、\n何も手につかないあなたへ。',
                bgImage: 'img/udatsu_lifestyle_casual_2_1764726937947.png',
                fontScale: 1,
                posX: 0,
                posY: 0
            },
            {
                type: 'content',
                tag: '現状',
                title: '「俺ならできる」と\n思い続けて数年。',
                text: '下積みと言い訳して、\nバイトに明け暮れる日々。\n\n本気にならず、\nGAFAの思惑通りに\n時間を消費していませんか？',
                bgImage: '',
                fontScale: 1,
                posX: 0,
                posY: 0
            },
            {
                type: 'content',
                tag: '解決策',
                title: '発信者になるための\n最初の一歩。',
                text: '文章が苦手でもいい。\nやる気が出なくてもいい。\n\nとりあえず、\nスマホに向かって喋るだけ。\nそれが「ボイスジャーナリング」です。',
                bgImage: 'img/udatsu_lifestyle_casual_3_1764726954817.png',
                fontScale: 1,
                posX: 0,
                posY: 0
            },
            {
                type: 'content',
                tag: 'メリット',
                title: '聞き返さなくていい。\n投げっぱなしでいい。',
                text: '録音した声は、\nAIとプロが「思考の資産」に変えます。\n\nあなたの声が、\nブログになり、遺言になり、\n未来のあなたの分身になります。',
                bgImage: '',
                fontScale: 1,
                posX: 0,
                posY: 0
            },
            {
                type: 'cta',
                tag: 'アクション',
                title: '声で「思考の資産」を\n残しませんか？',
                text: 'あなたが死んでも、\nあなたの思考は残り続ける。\n\nうだつサービスで、\nその一歩を踏み出しましょう。\n\n詳細はプロフィールリンクから\n→ @udatsuageteko',
                bgImage: 'img/udatsu_lifestyle_casual_1_1764726921299.png',
                fontScale: 1,
                posX: 0,
                posY: 0
            }
        ];

        let currentZoom = 0.3;
        let globalStyles = {
            'font-scale': 1.3,
            'overlay-opacity': 0.45,
            'bg-opacity': 0.5
        };

        function init() {
            renderInputs();
            renderAllSlides();
            applyZoom();
            updateGlobalStyleDisplay();
        }

        function renderInputs() {
            const container = document.getElementById('slide-inputs');
            container.innerHTML = ''; // Clear existing

            slidesData.forEach((slide, index) => {
                const group = document.createElement('div');
                group.className = 'control-group';
                group.innerHTML = `
                    <h3 onclick="toggleGroup(this)">Slide ${index + 1} <i class="fas fa-chevron-down"></i> 
                        ${slidesData.length > 1 ? `<span onclick="removeSlide(${index}, event)" style="float:right; color:#ff4d4d; font-size:0.8rem; margin-right:10px;"><i class="fas fa-trash"></i></span>` : ''}
                    </h3>
                    <div class="inputs-content" style="display: none;">
                        <label>Type</label>
                        <select onchange="updateSlide(${index}, 'type', this.value)">
                            <option value="cover" ${slide.type === 'cover' ? 'selected' : ''}>Cover</option>
                            <option value="content" ${slide.type === 'content' ? 'selected' : ''}>Content</option>
                            <option value="image-full" ${slide.type === 'image-full' ? 'selected' : ''}>Full Image</option>
                            <option value="cta" ${slide.type === 'cta' ? 'selected' : ''}>CTA</option>
                        </select>
                        
                        <label>Tag (Small Top)</label>
                        <input type="text" value="${slide.tag}" oninput="updateSlide(${index}, 'tag', this.value)">
                        
                        <label>Title (Big)</label>
                        <textarea oninput="updateSlide(${index}, 'title', this.value)">${slide.title}</textarea>
                        
                        <label>Body Text</label>
                        <textarea oninput="updateSlide(${index}, 'text', this.value)">${slide.text}</textarea>
                        
                        <label>Background Image (URL or Upload)</label>
                        <input type="text" placeholder="Image URL" value="${slide.bgImage || ''}" oninput="updateSlide(${index}, 'bgImage', this.value)">
                        <input type="file" accept="image/*" onchange="handleImageUpload(${index}, this)">
                        
                        <label>Font Scale (このスライドのみ)</label>
                        <input type="range" min="0.5" max="2" step="0.1" value="${slide.fontScale}" oninput="updateSlide(${index}, 'fontScale', this.value)">
                        <span id="slide-${index}-font-scale">${slide.fontScale}</span>
                        
                        <label>Position X (横位置)</label>
                        <input type="range" min="-200" max="200" step="10" value="${slide.posX}" oninput="updateSlide(${index}, 'posX', this.value)">
                        <span id="slide-${index}-posX">${slide.posX}px</span>
                        
                        <label>Position Y (縦位置)</label>
                        <input type="range" min="-200" max="200" step="10" value="${slide.posY}" oninput="updateSlide(${index}, 'posY', this.value)">
                        <span id="slide-${index}-posY">${slide.posY}px</span>
                    </div>
                `;
                container.appendChild(group);
            });
        }

        function renderAllSlides() {
            const slidesContainer = document.getElementById('slides-container');
            slidesContainer.innerHTML = ''; // Clear existing

            slidesData.forEach((_, index) => {
                const slideDiv = document.createElement('div');
                slideDiv.className = `slide slide-${index}`;
                slideDiv.id = `slide-${index}`;
                slidesContainer.appendChild(slideDiv);
                renderSlide(index);
            });
        }

        function addSlide() {
            if (slidesData.length >= 10) {
                alert('Max 10 slides allowed.');
                return;
            }
            slidesData.push({
                type: 'content',
                tag: 'NEW',
                title: 'New Slide',
                text: 'Text here...',
                bgImage: '',
                fontScale: 1,
                posX: 0,
                posY: 0
            });
            renderInputs();
            renderAllSlides();
        }

        function removeSlide(index, event) {
            event.stopPropagation();
            if (confirm('Delete this slide?')) {
                slidesData.splice(index, 1);
                renderInputs();
                renderAllSlides();
            }
        }

        function toggleGroup(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('i');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }

        function updateSlide(index, field, value) {
            slidesData[index][field] = value;

            // Update display values if element exists (might be hidden)
            const fontScaleEl = document.getElementById(`slide-${index}-font-scale`);
            if (fontScaleEl && field === 'fontScale') fontScaleEl.innerText = value;

            const posXEl = document.getElementById(`slide-${index}-posX`);
            if (posXEl && field === 'posX') posXEl.innerText = value + 'px';

            const posYEl = document.getElementById(`slide-${index}-posY`);
            if (posYEl && field === 'posY') posYEl.innerText = value + 'px';

            renderSlide(index);
        }

        function updateGlobalStyle(property, value) {
            globalStyles[property] = value;
            updateGlobalStyleDisplay();
            slidesData.forEach((_, index) => renderSlide(index));
        }

        function updateGlobalStyleDisplay() {
            document.getElementById('font-scale-value').innerText = globalStyles['font-scale'];
            document.getElementById('overlay-opacity-value').innerText = globalStyles['overlay-opacity'];
            document.getElementById('bg-opacity-value').innerText = globalStyles['bg-opacity'];
        }

        function handleImageUpload(index, input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    slidesData[index].bgImage = e.target.result;
                    renderSlide(index);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function renderSlide(index) {
            const data = slidesData[index];
            const el = document.getElementById(`slide-${index}`);
            if (!el) return;

            el.className = `slide layout-${data.type}`;

            const fontScale = (data.fontScale || 1) * globalStyles['font-scale'];
            el.style.setProperty('--font-scale', fontScale);
            el.style.setProperty('--overlay-opacity', globalStyles['overlay-opacity']);
            el.style.setProperty('--bg-opacity', globalStyles['bg-opacity']);
            el.style.setProperty('--pos-x', (data.posX || 0) + 'px');
            el.style.setProperty('--pos-y', (data.posY || 0) + 'px');

            const footerHtml = `
                <div class="slide-footer">
                    <div class="slide-footer-logo">
                        <img src="img/udatsu_logo.png" alt="Udatsu Logo">
                        Udatsu
                    </div>
                    <div class="slide-page-num">${index + 1 < 10 ? '0' + (index + 1) : index + 1}</div>
                </div>
            `;

            const bgImageHtml = data.bgImage ? `<img src="${data.bgImage}" class="slide-bg-image">` : '';

            let contentHtml = '';
            if (data.type === 'image-full') {
                contentHtml = `
                    ${bgImageHtml}
                    <div class="text-overlay">
                        <div class="slide-title" style="font-size: 3rem;">${data.title.replace(/\n/g, '<br>')}</div>
                    </div>
                `;
            } else {
                contentHtml = `
                    ${bgImageHtml}
                    <div class="slide-content">
                        <div class="slide-tag">${data.tag}</div>
                        <div class="slide-title">${data.title.replace(/\n/g, '<br>')}</div>
                        <div class="slide-text">${data.text.replace(/\n/g, '<br>')}</div>
                        ${footerHtml}
                    </div>
                `;
            }
            el.innerHTML = contentHtml;
        }

        function changeZoom(delta) {
            currentZoom += delta;
            if (currentZoom < 0.1) currentZoom = 0.1;
            if (currentZoom > 2) currentZoom = 2;
            applyZoom();
        }

        function applyZoom() {
            const container = document.getElementById('slides-container');
            if (!document.body.classList.contains('export-mode')) {
                container.style.transform = `scale(${currentZoom})`;
            }
            document.getElementById('zoom-level').innerText = Math.round(currentZoom * 100) + '%';
        }

        function toggleExportMode() {
            document.body.classList.toggle('export-mode');
            const container = document.getElementById('slides-container');
            const zoomControls = document.getElementById('zoom-controls');

            if (document.body.classList.contains('export-mode')) {
                container.style.transform = 'none';
                zoomControls.style.display = 'none';
            } else {
                applyZoom();
                zoomControls.style.display = 'flex';
            }
        }

        async function downloadAllImages() {
            const slides = document.querySelectorAll('.slide');
            const exportBtn = document.querySelector('.export-controls button:last-child');
            const originalText = exportBtn.innerHTML;
            exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            for (let i = 0; i < slides.length; i++) {
                const slide = slides[i];
                try {
                    // Workaround: Temporarily replace background images with Data URLs if they are local
                    // This is complex to do purely client-side without a server for file://
                    // So we try standard html2canvas first.

                    const canvas = await html2canvas(slide, {
                        scale: 2, // High resolution
                        useCORS: true,
                        allowTaint: true, // Allow tainted canvas (might block download)
                        backgroundColor: '#2a2a2a', // Ensure background is not transparent
                        logging: false
                    });

                    // Convert to blob to handle large images better
                    canvas.toBlob(function (blob) {
                        if (!blob) {
                            console.error('Canvas is empty');
                            return;
                        }
                        const link = document.createElement('a');
                        link.download = `udatsu_slide_${i + 1}.png`;
                        link.href = URL.createObjectURL(blob);
                        link.click();
                        URL.revokeObjectURL(link.href);
                    }, 'image/png');

                    // Small delay to prevent browser throttling downloads
                    await new Promise(resolve => setTimeout(resolve, 500));

                } catch (err) {
                    console.error('Download failed:', err);
                    alert(`Slide ${i + 1} download failed. This is likely due to browser security restrictions on local files.\nPlease use Screenshot Mode instead.`);
                }
            }

            exportBtn.innerHTML = originalText;
        }

        // Initialize
        init();

    </script>
</body>

</html>